<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>sentinel | KNOTE</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_3114978_qe0b39no76.css">
    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js"></script>
    <script>var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?267c5680c2ffb468ca29c45ffe6801da"; 
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
          </script>
    <meta name="description" content="学习Java, Web, 框架, 微服务, 工具, 前端等相关知识, 记录生活和技术路程, 同时分享编程技巧。">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta name="keywords" content="学习Java、Web、框架、微服务、工具、前端等相关知识, 记录生活和技术路程。">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.ef7cd65c.css" as="style"><link rel="preload" href="/assets/js/app.be13efeb.js" as="script"><link rel="preload" href="/assets/js/2.6721fee8.js" as="script"><link rel="preload" href="/assets/js/518.c38887f9.js" as="script"><link rel="preload" href="/assets/js/4.7df05356.js" as="script"><link rel="prefetch" href="/assets/js/10.9fc0ad5e.js"><link rel="prefetch" href="/assets/js/100.445a953f.js"><link rel="prefetch" href="/assets/js/101.50f3f636.js"><link rel="prefetch" href="/assets/js/102.ea01a0a9.js"><link rel="prefetch" href="/assets/js/103.48c80b71.js"><link rel="prefetch" href="/assets/js/104.c1304567.js"><link rel="prefetch" href="/assets/js/105.21f8b504.js"><link rel="prefetch" href="/assets/js/106.bc15f6b1.js"><link rel="prefetch" href="/assets/js/107.369451a9.js"><link rel="prefetch" href="/assets/js/108.ad4f8dbb.js"><link rel="prefetch" href="/assets/js/109.4c0ac598.js"><link rel="prefetch" href="/assets/js/11.571f9844.js"><link rel="prefetch" href="/assets/js/110.1e132789.js"><link rel="prefetch" href="/assets/js/111.3e69498d.js"><link rel="prefetch" href="/assets/js/112.cb20729c.js"><link rel="prefetch" href="/assets/js/113.2f080aa8.js"><link rel="prefetch" href="/assets/js/114.99d37d0a.js"><link rel="prefetch" href="/assets/js/115.aa87050b.js"><link rel="prefetch" href="/assets/js/116.b5fa1b2e.js"><link rel="prefetch" href="/assets/js/117.01d3ca92.js"><link rel="prefetch" href="/assets/js/118.efbecdc5.js"><link rel="prefetch" href="/assets/js/119.8ad5c904.js"><link rel="prefetch" href="/assets/js/12.a3002f91.js"><link rel="prefetch" href="/assets/js/120.f9d2779e.js"><link rel="prefetch" href="/assets/js/121.77249b18.js"><link rel="prefetch" href="/assets/js/122.c9167ca2.js"><link rel="prefetch" href="/assets/js/123.70789fe4.js"><link rel="prefetch" href="/assets/js/124.e1f1ba48.js"><link rel="prefetch" href="/assets/js/125.05e8e963.js"><link rel="prefetch" href="/assets/js/126.87fa90c1.js"><link rel="prefetch" href="/assets/js/127.d36d7dfd.js"><link rel="prefetch" href="/assets/js/128.729d369a.js"><link rel="prefetch" href="/assets/js/129.bdd0e080.js"><link rel="prefetch" href="/assets/js/13.d769b73a.js"><link rel="prefetch" href="/assets/js/130.17b3a98a.js"><link rel="prefetch" href="/assets/js/131.6462d2dd.js"><link rel="prefetch" href="/assets/js/132.9f77f2b3.js"><link rel="prefetch" href="/assets/js/133.b11dacc2.js"><link rel="prefetch" href="/assets/js/134.f94bc9ab.js"><link rel="prefetch" href="/assets/js/135.592b15b0.js"><link rel="prefetch" href="/assets/js/136.358ac083.js"><link rel="prefetch" href="/assets/js/137.8e5be7ac.js"><link rel="prefetch" href="/assets/js/138.a1358061.js"><link rel="prefetch" href="/assets/js/139.5f959387.js"><link rel="prefetch" href="/assets/js/14.96b83c4a.js"><link rel="prefetch" href="/assets/js/140.e034ec3e.js"><link rel="prefetch" href="/assets/js/141.cf28f196.js"><link rel="prefetch" href="/assets/js/142.005c6885.js"><link rel="prefetch" href="/assets/js/143.92dbb563.js"><link rel="prefetch" href="/assets/js/144.263bc914.js"><link rel="prefetch" href="/assets/js/145.ba7404c7.js"><link rel="prefetch" href="/assets/js/146.8c5c427e.js"><link rel="prefetch" href="/assets/js/147.15f5203d.js"><link rel="prefetch" href="/assets/js/148.b2294b7e.js"><link rel="prefetch" href="/assets/js/149.29566afd.js"><link rel="prefetch" href="/assets/js/15.456873d3.js"><link rel="prefetch" href="/assets/js/150.e513c541.js"><link rel="prefetch" href="/assets/js/151.feac0309.js"><link rel="prefetch" href="/assets/js/152.6b80af4d.js"><link rel="prefetch" href="/assets/js/153.663db95c.js"><link rel="prefetch" href="/assets/js/154.027f8e44.js"><link rel="prefetch" href="/assets/js/155.472d5cc5.js"><link rel="prefetch" href="/assets/js/156.adbc4f7d.js"><link rel="prefetch" href="/assets/js/157.9c2e3c48.js"><link rel="prefetch" href="/assets/js/158.1b927721.js"><link rel="prefetch" href="/assets/js/159.6887401e.js"><link rel="prefetch" href="/assets/js/16.13dd0421.js"><link rel="prefetch" href="/assets/js/160.dc3fcdbe.js"><link rel="prefetch" href="/assets/js/161.92df3db6.js"><link rel="prefetch" href="/assets/js/162.3d998157.js"><link rel="prefetch" href="/assets/js/163.ccf415fb.js"><link rel="prefetch" href="/assets/js/164.5c460632.js"><link rel="prefetch" href="/assets/js/165.4644071d.js"><link rel="prefetch" href="/assets/js/166.c0f8bab5.js"><link rel="prefetch" href="/assets/js/167.fa6727bf.js"><link rel="prefetch" href="/assets/js/168.a69e9264.js"><link rel="prefetch" href="/assets/js/169.3f276231.js"><link rel="prefetch" href="/assets/js/17.0d0d70be.js"><link rel="prefetch" href="/assets/js/170.07ad4c0d.js"><link rel="prefetch" href="/assets/js/171.bba2325a.js"><link rel="prefetch" href="/assets/js/172.18bb4010.js"><link rel="prefetch" href="/assets/js/173.08665888.js"><link rel="prefetch" href="/assets/js/174.e226515b.js"><link rel="prefetch" href="/assets/js/175.d9e7eff1.js"><link rel="prefetch" href="/assets/js/176.aae678ec.js"><link rel="prefetch" href="/assets/js/177.66366b65.js"><link rel="prefetch" href="/assets/js/178.f1dc8fcf.js"><link rel="prefetch" href="/assets/js/179.58bbef7b.js"><link rel="prefetch" href="/assets/js/18.3d7ad613.js"><link rel="prefetch" href="/assets/js/180.5670e6d4.js"><link rel="prefetch" href="/assets/js/181.c4b18cfb.js"><link rel="prefetch" href="/assets/js/182.fe847048.js"><link rel="prefetch" href="/assets/js/183.531b6c4e.js"><link rel="prefetch" href="/assets/js/184.8cd79eb1.js"><link rel="prefetch" href="/assets/js/185.d0c46c5e.js"><link rel="prefetch" href="/assets/js/186.0defd941.js"><link rel="prefetch" href="/assets/js/187.5487a6fd.js"><link rel="prefetch" href="/assets/js/188.553b85b1.js"><link rel="prefetch" href="/assets/js/189.8c79812e.js"><link rel="prefetch" href="/assets/js/19.a903a732.js"><link rel="prefetch" href="/assets/js/190.d2064022.js"><link rel="prefetch" href="/assets/js/191.aa182c57.js"><link rel="prefetch" href="/assets/js/192.46a492bb.js"><link rel="prefetch" href="/assets/js/193.b032a923.js"><link rel="prefetch" href="/assets/js/194.501d2ff8.js"><link rel="prefetch" href="/assets/js/195.d050ca2f.js"><link rel="prefetch" href="/assets/js/196.8d74c0e4.js"><link rel="prefetch" href="/assets/js/197.902e46b4.js"><link rel="prefetch" href="/assets/js/198.296ffc6b.js"><link rel="prefetch" href="/assets/js/199.7d6ec003.js"><link rel="prefetch" href="/assets/js/20.ace6ca43.js"><link rel="prefetch" href="/assets/js/200.09c3569d.js"><link rel="prefetch" href="/assets/js/201.b5fd8aea.js"><link rel="prefetch" href="/assets/js/202.d4148767.js"><link rel="prefetch" href="/assets/js/203.24256bee.js"><link rel="prefetch" href="/assets/js/204.8668a823.js"><link rel="prefetch" href="/assets/js/205.86b35550.js"><link rel="prefetch" href="/assets/js/206.108543fc.js"><link rel="prefetch" href="/assets/js/207.401807da.js"><link rel="prefetch" href="/assets/js/208.d0d16f62.js"><link rel="prefetch" href="/assets/js/209.5f85f70d.js"><link rel="prefetch" href="/assets/js/21.3180c41b.js"><link rel="prefetch" href="/assets/js/210.c7e1a0f7.js"><link rel="prefetch" href="/assets/js/211.d0d0049e.js"><link rel="prefetch" href="/assets/js/212.4449a934.js"><link rel="prefetch" href="/assets/js/213.26ed2de8.js"><link rel="prefetch" href="/assets/js/214.d5d951fb.js"><link rel="prefetch" href="/assets/js/215.52f822c3.js"><link rel="prefetch" href="/assets/js/216.fef91b5c.js"><link rel="prefetch" href="/assets/js/217.9703ec89.js"><link rel="prefetch" href="/assets/js/218.1fc1108b.js"><link rel="prefetch" href="/assets/js/219.716760e5.js"><link rel="prefetch" href="/assets/js/22.dc4e825a.js"><link rel="prefetch" href="/assets/js/220.feca2555.js"><link rel="prefetch" href="/assets/js/221.20434b00.js"><link rel="prefetch" href="/assets/js/222.1583c395.js"><link rel="prefetch" href="/assets/js/223.9dee736e.js"><link rel="prefetch" href="/assets/js/224.b38a4279.js"><link rel="prefetch" href="/assets/js/225.95e1ee3a.js"><link rel="prefetch" href="/assets/js/226.23994a6a.js"><link rel="prefetch" href="/assets/js/227.b1a0221b.js"><link rel="prefetch" href="/assets/js/228.9d8f821b.js"><link rel="prefetch" href="/assets/js/229.4cdf2c59.js"><link rel="prefetch" href="/assets/js/23.77cffbcd.js"><link rel="prefetch" href="/assets/js/230.9b82e4da.js"><link rel="prefetch" href="/assets/js/231.453b67d6.js"><link rel="prefetch" href="/assets/js/232.cbf18b51.js"><link rel="prefetch" href="/assets/js/233.bba5884d.js"><link rel="prefetch" href="/assets/js/234.bb37aa51.js"><link rel="prefetch" href="/assets/js/235.380fc23e.js"><link rel="prefetch" href="/assets/js/236.48827a8e.js"><link rel="prefetch" href="/assets/js/237.6076f1eb.js"><link rel="prefetch" href="/assets/js/238.44bdac10.js"><link rel="prefetch" href="/assets/js/239.09968718.js"><link rel="prefetch" href="/assets/js/24.0875dace.js"><link rel="prefetch" href="/assets/js/240.24cc7265.js"><link rel="prefetch" href="/assets/js/241.764f0120.js"><link rel="prefetch" href="/assets/js/242.98e839c4.js"><link rel="prefetch" href="/assets/js/243.dfaf5b0f.js"><link rel="prefetch" href="/assets/js/244.6dbe170b.js"><link rel="prefetch" href="/assets/js/245.f0cf26b8.js"><link rel="prefetch" href="/assets/js/246.89dbfa00.js"><link rel="prefetch" href="/assets/js/247.f245ff82.js"><link rel="prefetch" href="/assets/js/248.e321588d.js"><link rel="prefetch" href="/assets/js/249.78519da7.js"><link rel="prefetch" href="/assets/js/25.b8c0e9b3.js"><link rel="prefetch" href="/assets/js/250.8c9f6c12.js"><link rel="prefetch" href="/assets/js/251.854095e0.js"><link rel="prefetch" href="/assets/js/252.11904a27.js"><link rel="prefetch" href="/assets/js/253.a2ef15c0.js"><link rel="prefetch" href="/assets/js/254.24aa1a5f.js"><link rel="prefetch" href="/assets/js/255.ad478f7c.js"><link rel="prefetch" href="/assets/js/256.f578e658.js"><link rel="prefetch" href="/assets/js/257.3372f368.js"><link rel="prefetch" href="/assets/js/258.5a31555d.js"><link rel="prefetch" href="/assets/js/259.ac3240e3.js"><link rel="prefetch" href="/assets/js/26.09fa8bef.js"><link rel="prefetch" href="/assets/js/260.a4a13e65.js"><link rel="prefetch" href="/assets/js/261.7bc38b45.js"><link rel="prefetch" href="/assets/js/262.a0b99b19.js"><link rel="prefetch" href="/assets/js/263.b0ff4be3.js"><link rel="prefetch" href="/assets/js/264.0fb5638f.js"><link rel="prefetch" href="/assets/js/265.3ee362b2.js"><link rel="prefetch" href="/assets/js/266.64fa79ac.js"><link rel="prefetch" href="/assets/js/267.85dfb5a6.js"><link rel="prefetch" href="/assets/js/268.18d5a909.js"><link rel="prefetch" href="/assets/js/269.737840b8.js"><link rel="prefetch" href="/assets/js/27.16c9b9e6.js"><link rel="prefetch" href="/assets/js/270.80efb202.js"><link rel="prefetch" href="/assets/js/271.cce81f5c.js"><link rel="prefetch" href="/assets/js/272.a17b419d.js"><link rel="prefetch" href="/assets/js/273.4869cb0e.js"><link rel="prefetch" href="/assets/js/274.d7fd3e4f.js"><link rel="prefetch" href="/assets/js/275.f9742da4.js"><link rel="prefetch" href="/assets/js/276.8bc5b1a8.js"><link rel="prefetch" href="/assets/js/277.a6ce8db8.js"><link rel="prefetch" href="/assets/js/278.8a1bae97.js"><link rel="prefetch" href="/assets/js/279.a04e0f08.js"><link rel="prefetch" href="/assets/js/28.24adc85f.js"><link rel="prefetch" href="/assets/js/280.f79053e2.js"><link rel="prefetch" href="/assets/js/281.7d70ccb4.js"><link rel="prefetch" href="/assets/js/282.6f977d09.js"><link rel="prefetch" href="/assets/js/283.a1a3961b.js"><link rel="prefetch" href="/assets/js/284.0cc3a88d.js"><link rel="prefetch" href="/assets/js/285.ac2aa22c.js"><link rel="prefetch" href="/assets/js/286.62986a24.js"><link rel="prefetch" href="/assets/js/287.af36ae8c.js"><link rel="prefetch" href="/assets/js/288.0e2fe765.js"><link rel="prefetch" href="/assets/js/289.3564ceaf.js"><link rel="prefetch" href="/assets/js/29.89ce61b5.js"><link rel="prefetch" href="/assets/js/290.f9b09a95.js"><link rel="prefetch" href="/assets/js/291.9b3a9a57.js"><link rel="prefetch" href="/assets/js/292.85dc7aa1.js"><link rel="prefetch" href="/assets/js/293.06642a16.js"><link rel="prefetch" href="/assets/js/294.e24caa94.js"><link rel="prefetch" href="/assets/js/295.b6630c82.js"><link rel="prefetch" href="/assets/js/296.d5fc6e7c.js"><link rel="prefetch" href="/assets/js/297.bcad016d.js"><link rel="prefetch" href="/assets/js/298.e9a67a4f.js"><link rel="prefetch" href="/assets/js/299.2d14da00.js"><link rel="prefetch" href="/assets/js/3.17f360d0.js"><link rel="prefetch" href="/assets/js/30.d1aa8054.js"><link rel="prefetch" href="/assets/js/300.9b6f85d0.js"><link rel="prefetch" href="/assets/js/301.baabd774.js"><link rel="prefetch" href="/assets/js/302.8a5bfa2c.js"><link rel="prefetch" href="/assets/js/303.0552127d.js"><link rel="prefetch" href="/assets/js/304.81bed0dd.js"><link rel="prefetch" href="/assets/js/305.db90e4bf.js"><link rel="prefetch" href="/assets/js/306.b2e515b7.js"><link rel="prefetch" href="/assets/js/307.8a0e359e.js"><link rel="prefetch" href="/assets/js/308.360167d7.js"><link rel="prefetch" href="/assets/js/309.1f88b629.js"><link rel="prefetch" href="/assets/js/31.2b4287b8.js"><link rel="prefetch" href="/assets/js/310.149fcb47.js"><link rel="prefetch" href="/assets/js/311.7a6b7e94.js"><link rel="prefetch" href="/assets/js/312.4f1bbcb2.js"><link rel="prefetch" href="/assets/js/313.ed0a9e5c.js"><link rel="prefetch" href="/assets/js/314.21919778.js"><link rel="prefetch" href="/assets/js/315.61c57cff.js"><link rel="prefetch" href="/assets/js/316.ae4287ac.js"><link rel="prefetch" href="/assets/js/317.5a06e49e.js"><link rel="prefetch" href="/assets/js/318.5c91e85c.js"><link rel="prefetch" href="/assets/js/319.4c6dc25b.js"><link rel="prefetch" href="/assets/js/32.f7174bfe.js"><link rel="prefetch" href="/assets/js/320.e63ef187.js"><link rel="prefetch" href="/assets/js/321.19e6d42f.js"><link rel="prefetch" href="/assets/js/322.80170711.js"><link rel="prefetch" href="/assets/js/323.7e9c3cdc.js"><link rel="prefetch" href="/assets/js/324.286b2957.js"><link rel="prefetch" href="/assets/js/325.9bca4d0d.js"><link rel="prefetch" href="/assets/js/326.182d121f.js"><link rel="prefetch" href="/assets/js/327.dd5929c0.js"><link rel="prefetch" href="/assets/js/328.60107055.js"><link rel="prefetch" href="/assets/js/329.422533d7.js"><link rel="prefetch" href="/assets/js/33.ee922c4d.js"><link rel="prefetch" href="/assets/js/330.c6c2a508.js"><link rel="prefetch" href="/assets/js/331.c80d9de5.js"><link rel="prefetch" href="/assets/js/332.eb0af05f.js"><link rel="prefetch" href="/assets/js/333.61c3117a.js"><link rel="prefetch" href="/assets/js/334.36894e06.js"><link rel="prefetch" href="/assets/js/335.7ba144e9.js"><link rel="prefetch" href="/assets/js/336.5cd831f9.js"><link rel="prefetch" href="/assets/js/337.54b04ae2.js"><link rel="prefetch" href="/assets/js/338.65b1a3c1.js"><link rel="prefetch" href="/assets/js/339.808d3284.js"><link rel="prefetch" href="/assets/js/34.de720458.js"><link rel="prefetch" href="/assets/js/340.75befd5d.js"><link rel="prefetch" href="/assets/js/341.8f35cb19.js"><link rel="prefetch" href="/assets/js/342.df708318.js"><link rel="prefetch" href="/assets/js/343.fce19338.js"><link rel="prefetch" href="/assets/js/344.c1a3920f.js"><link rel="prefetch" href="/assets/js/345.d0675e31.js"><link rel="prefetch" href="/assets/js/346.fdf08890.js"><link rel="prefetch" href="/assets/js/347.8274a5b6.js"><link rel="prefetch" href="/assets/js/348.9dd931a4.js"><link rel="prefetch" href="/assets/js/349.254fe21d.js"><link rel="prefetch" href="/assets/js/35.4454ea43.js"><link rel="prefetch" href="/assets/js/350.941e7270.js"><link rel="prefetch" href="/assets/js/351.94e380ac.js"><link rel="prefetch" href="/assets/js/352.841dd34f.js"><link rel="prefetch" href="/assets/js/353.ba4b3072.js"><link rel="prefetch" href="/assets/js/354.2ddd6766.js"><link rel="prefetch" href="/assets/js/355.e66c7289.js"><link rel="prefetch" href="/assets/js/356.920b3ebb.js"><link rel="prefetch" href="/assets/js/357.dca11ccb.js"><link rel="prefetch" href="/assets/js/358.7ec2160b.js"><link rel="prefetch" href="/assets/js/359.f4b533d1.js"><link rel="prefetch" href="/assets/js/36.d9c2a9db.js"><link rel="prefetch" href="/assets/js/360.bd21b670.js"><link rel="prefetch" href="/assets/js/361.52ffa5a1.js"><link rel="prefetch" href="/assets/js/362.68ba7cdd.js"><link rel="prefetch" href="/assets/js/363.78cc63b6.js"><link rel="prefetch" href="/assets/js/364.452e6e03.js"><link rel="prefetch" href="/assets/js/365.a5bf58af.js"><link rel="prefetch" href="/assets/js/366.a2652a53.js"><link rel="prefetch" href="/assets/js/367.df61be65.js"><link rel="prefetch" href="/assets/js/368.b68bb759.js"><link rel="prefetch" href="/assets/js/369.fdab3f73.js"><link rel="prefetch" href="/assets/js/37.2e8cbe24.js"><link rel="prefetch" href="/assets/js/370.ce53a7bb.js"><link rel="prefetch" href="/assets/js/371.dc258d49.js"><link rel="prefetch" href="/assets/js/372.0b1edb7e.js"><link rel="prefetch" href="/assets/js/373.98063c74.js"><link rel="prefetch" href="/assets/js/374.51d40903.js"><link rel="prefetch" href="/assets/js/375.f87599bb.js"><link rel="prefetch" href="/assets/js/376.e3dc8984.js"><link rel="prefetch" href="/assets/js/377.c5079600.js"><link rel="prefetch" href="/assets/js/378.e3dcf9fd.js"><link rel="prefetch" href="/assets/js/379.ddf55724.js"><link rel="prefetch" href="/assets/js/38.1913a7d7.js"><link rel="prefetch" href="/assets/js/380.868298bf.js"><link rel="prefetch" href="/assets/js/381.47029fa4.js"><link rel="prefetch" href="/assets/js/382.1323e975.js"><link rel="prefetch" href="/assets/js/383.ac7f1567.js"><link rel="prefetch" href="/assets/js/384.3eb329f8.js"><link rel="prefetch" href="/assets/js/385.9e349f5e.js"><link rel="prefetch" href="/assets/js/386.ef40ce05.js"><link rel="prefetch" href="/assets/js/387.6c362542.js"><link rel="prefetch" href="/assets/js/388.524cd102.js"><link rel="prefetch" href="/assets/js/389.296b706c.js"><link rel="prefetch" href="/assets/js/39.5aed1637.js"><link rel="prefetch" href="/assets/js/390.6c6d77d1.js"><link rel="prefetch" href="/assets/js/391.c6556dad.js"><link rel="prefetch" href="/assets/js/392.f6c05801.js"><link rel="prefetch" href="/assets/js/393.10b84c25.js"><link rel="prefetch" href="/assets/js/394.7edec3a1.js"><link rel="prefetch" href="/assets/js/395.7c5029b8.js"><link rel="prefetch" href="/assets/js/396.a1a62605.js"><link rel="prefetch" href="/assets/js/397.be9e9cf5.js"><link rel="prefetch" href="/assets/js/398.372e1855.js"><link rel="prefetch" href="/assets/js/399.494167f8.js"><link rel="prefetch" href="/assets/js/40.9614bca4.js"><link rel="prefetch" href="/assets/js/400.18f13f62.js"><link rel="prefetch" href="/assets/js/401.ec29b9ae.js"><link rel="prefetch" href="/assets/js/402.b4b3ed10.js"><link rel="prefetch" href="/assets/js/403.dacb6823.js"><link rel="prefetch" href="/assets/js/404.bd7b3e65.js"><link rel="prefetch" href="/assets/js/405.252618e9.js"><link rel="prefetch" href="/assets/js/406.ab258b56.js"><link rel="prefetch" href="/assets/js/407.fc91b307.js"><link rel="prefetch" href="/assets/js/408.1f61bbb4.js"><link rel="prefetch" href="/assets/js/409.63457ce7.js"><link rel="prefetch" href="/assets/js/41.4c9121f8.js"><link rel="prefetch" href="/assets/js/410.d7596150.js"><link rel="prefetch" href="/assets/js/411.06cf9614.js"><link rel="prefetch" href="/assets/js/412.b54366dd.js"><link rel="prefetch" href="/assets/js/413.3e89e98b.js"><link rel="prefetch" href="/assets/js/414.b0f580d6.js"><link rel="prefetch" href="/assets/js/415.3bad3c01.js"><link rel="prefetch" href="/assets/js/416.a3510681.js"><link rel="prefetch" href="/assets/js/417.2c5d1142.js"><link rel="prefetch" href="/assets/js/418.87d22ee2.js"><link rel="prefetch" href="/assets/js/419.ba41b959.js"><link rel="prefetch" href="/assets/js/42.94741244.js"><link rel="prefetch" href="/assets/js/420.add76658.js"><link rel="prefetch" href="/assets/js/421.9bdf7fe7.js"><link rel="prefetch" href="/assets/js/422.8d07f71e.js"><link rel="prefetch" href="/assets/js/423.f28f89c1.js"><link rel="prefetch" href="/assets/js/424.60811254.js"><link rel="prefetch" href="/assets/js/425.2319dbe6.js"><link rel="prefetch" href="/assets/js/426.4b80d3d9.js"><link rel="prefetch" href="/assets/js/427.49de3f3e.js"><link rel="prefetch" href="/assets/js/428.fb29b2a8.js"><link rel="prefetch" href="/assets/js/429.0cae4902.js"><link rel="prefetch" href="/assets/js/43.0d7c9098.js"><link rel="prefetch" href="/assets/js/430.17d2231a.js"><link rel="prefetch" href="/assets/js/431.6954bf71.js"><link rel="prefetch" href="/assets/js/432.053b873f.js"><link rel="prefetch" href="/assets/js/433.9e0c2d89.js"><link rel="prefetch" href="/assets/js/434.504050de.js"><link rel="prefetch" href="/assets/js/435.837dce81.js"><link rel="prefetch" href="/assets/js/436.8bbc738e.js"><link rel="prefetch" href="/assets/js/437.a4fc45e7.js"><link rel="prefetch" href="/assets/js/438.bf255804.js"><link rel="prefetch" href="/assets/js/439.364a3d38.js"><link rel="prefetch" href="/assets/js/44.49b4ebc7.js"><link rel="prefetch" href="/assets/js/440.c6d5f478.js"><link rel="prefetch" href="/assets/js/441.ba50046b.js"><link rel="prefetch" href="/assets/js/442.3bce92c3.js"><link rel="prefetch" href="/assets/js/443.00c98cfe.js"><link rel="prefetch" href="/assets/js/444.5664322e.js"><link rel="prefetch" href="/assets/js/445.877f66a1.js"><link rel="prefetch" href="/assets/js/446.aa840c2f.js"><link rel="prefetch" href="/assets/js/447.b026ffb2.js"><link rel="prefetch" href="/assets/js/448.b28aa71a.js"><link rel="prefetch" href="/assets/js/449.48f8eff1.js"><link rel="prefetch" href="/assets/js/45.03dfcebf.js"><link rel="prefetch" href="/assets/js/450.28853153.js"><link rel="prefetch" href="/assets/js/451.19d0767a.js"><link rel="prefetch" href="/assets/js/452.f8878832.js"><link rel="prefetch" href="/assets/js/453.281e0135.js"><link rel="prefetch" href="/assets/js/454.3431cf32.js"><link rel="prefetch" href="/assets/js/455.71a68d78.js"><link rel="prefetch" href="/assets/js/456.bfb0c6b5.js"><link rel="prefetch" href="/assets/js/457.9effc9c6.js"><link rel="prefetch" href="/assets/js/458.75b4a9e0.js"><link rel="prefetch" href="/assets/js/459.dc2ee8a9.js"><link rel="prefetch" href="/assets/js/46.2cae6041.js"><link rel="prefetch" href="/assets/js/460.c875a9e6.js"><link rel="prefetch" href="/assets/js/461.6973d8d5.js"><link rel="prefetch" href="/assets/js/462.efe609b9.js"><link rel="prefetch" href="/assets/js/463.760957a6.js"><link rel="prefetch" href="/assets/js/464.bc530c49.js"><link rel="prefetch" href="/assets/js/465.329a71e6.js"><link rel="prefetch" href="/assets/js/466.b1557f33.js"><link rel="prefetch" href="/assets/js/467.da228937.js"><link rel="prefetch" href="/assets/js/468.3afb2ecf.js"><link rel="prefetch" href="/assets/js/469.b5e5e142.js"><link rel="prefetch" href="/assets/js/47.4d8b752a.js"><link rel="prefetch" href="/assets/js/470.9905d72e.js"><link rel="prefetch" href="/assets/js/471.e10e3102.js"><link rel="prefetch" href="/assets/js/472.7477c1b0.js"><link rel="prefetch" href="/assets/js/473.10527fde.js"><link rel="prefetch" href="/assets/js/474.24ed3c8d.js"><link rel="prefetch" href="/assets/js/475.9c283a73.js"><link rel="prefetch" href="/assets/js/476.ecd2ad0e.js"><link rel="prefetch" href="/assets/js/477.a9c10c46.js"><link rel="prefetch" href="/assets/js/478.5ca857f6.js"><link rel="prefetch" href="/assets/js/479.057c929a.js"><link rel="prefetch" href="/assets/js/48.2133e19b.js"><link rel="prefetch" href="/assets/js/480.f6a0b718.js"><link rel="prefetch" href="/assets/js/481.2a9514fb.js"><link rel="prefetch" href="/assets/js/482.19e10a70.js"><link rel="prefetch" href="/assets/js/483.72d185e1.js"><link rel="prefetch" href="/assets/js/484.bd878cf9.js"><link rel="prefetch" href="/assets/js/485.0b7a3680.js"><link rel="prefetch" href="/assets/js/486.738508de.js"><link rel="prefetch" href="/assets/js/487.a28376ba.js"><link rel="prefetch" href="/assets/js/488.27a265da.js"><link rel="prefetch" href="/assets/js/489.df9b7df2.js"><link rel="prefetch" href="/assets/js/49.b40fa721.js"><link rel="prefetch" href="/assets/js/490.b00c77e7.js"><link rel="prefetch" href="/assets/js/491.8ce596f8.js"><link rel="prefetch" href="/assets/js/492.6da0b951.js"><link rel="prefetch" href="/assets/js/493.194142a4.js"><link rel="prefetch" href="/assets/js/494.525df756.js"><link rel="prefetch" href="/assets/js/495.98e87f8b.js"><link rel="prefetch" href="/assets/js/496.38003e2d.js"><link rel="prefetch" href="/assets/js/497.b0a8634b.js"><link rel="prefetch" href="/assets/js/498.b58d6c6f.js"><link rel="prefetch" href="/assets/js/499.8d7790f2.js"><link rel="prefetch" href="/assets/js/5.5e361e5e.js"><link rel="prefetch" href="/assets/js/50.764cf6f8.js"><link rel="prefetch" href="/assets/js/500.74246557.js"><link rel="prefetch" href="/assets/js/501.69865b84.js"><link rel="prefetch" href="/assets/js/502.8a5aadec.js"><link rel="prefetch" href="/assets/js/503.5a73da6a.js"><link rel="prefetch" href="/assets/js/504.99a194f4.js"><link rel="prefetch" href="/assets/js/505.ba8e9f9a.js"><link rel="prefetch" href="/assets/js/506.62b81c0a.js"><link rel="prefetch" href="/assets/js/507.28abce36.js"><link rel="prefetch" href="/assets/js/508.29669b9c.js"><link rel="prefetch" href="/assets/js/509.9878a033.js"><link rel="prefetch" href="/assets/js/51.81b21a23.js"><link rel="prefetch" href="/assets/js/510.05d83afc.js"><link rel="prefetch" href="/assets/js/511.eb3195ff.js"><link rel="prefetch" href="/assets/js/512.a7002238.js"><link rel="prefetch" href="/assets/js/513.22a7f09a.js"><link rel="prefetch" href="/assets/js/514.75f4d771.js"><link rel="prefetch" href="/assets/js/515.8584e42f.js"><link rel="prefetch" href="/assets/js/516.7a30e6b6.js"><link rel="prefetch" href="/assets/js/517.a9f3a2fd.js"><link rel="prefetch" href="/assets/js/519.7cd822e2.js"><link rel="prefetch" href="/assets/js/52.b1ffb904.js"><link rel="prefetch" href="/assets/js/520.e73e7ff9.js"><link rel="prefetch" href="/assets/js/521.9ab850a5.js"><link rel="prefetch" href="/assets/js/522.f6751bd1.js"><link rel="prefetch" href="/assets/js/523.6f627afc.js"><link rel="prefetch" href="/assets/js/524.c060952e.js"><link rel="prefetch" href="/assets/js/525.6f2a5f32.js"><link rel="prefetch" href="/assets/js/526.7c2ab23e.js"><link rel="prefetch" href="/assets/js/527.36f20115.js"><link rel="prefetch" href="/assets/js/528.6be037b0.js"><link rel="prefetch" href="/assets/js/529.91d25836.js"><link rel="prefetch" href="/assets/js/53.bcbeb201.js"><link rel="prefetch" href="/assets/js/530.efb60ab9.js"><link rel="prefetch" href="/assets/js/531.989c79c0.js"><link rel="prefetch" href="/assets/js/532.e840b5c1.js"><link rel="prefetch" href="/assets/js/533.a71ba3c3.js"><link rel="prefetch" href="/assets/js/534.c35d83bf.js"><link rel="prefetch" href="/assets/js/535.a1792b22.js"><link rel="prefetch" href="/assets/js/536.4613ebf6.js"><link rel="prefetch" href="/assets/js/537.d48f5626.js"><link rel="prefetch" href="/assets/js/538.db962bd6.js"><link rel="prefetch" href="/assets/js/539.617c1259.js"><link rel="prefetch" href="/assets/js/54.d684ca2d.js"><link rel="prefetch" href="/assets/js/540.17f0f7cc.js"><link rel="prefetch" href="/assets/js/541.6904dd50.js"><link rel="prefetch" href="/assets/js/542.d1d9119e.js"><link rel="prefetch" href="/assets/js/55.8a30377a.js"><link rel="prefetch" href="/assets/js/56.b68c0d3c.js"><link rel="prefetch" href="/assets/js/57.07c8c60e.js"><link rel="prefetch" href="/assets/js/58.447581b8.js"><link rel="prefetch" href="/assets/js/59.80f69fa5.js"><link rel="prefetch" href="/assets/js/6.d326a394.js"><link rel="prefetch" href="/assets/js/60.6268fb7c.js"><link rel="prefetch" href="/assets/js/61.4f37698f.js"><link rel="prefetch" href="/assets/js/62.f7ce00d9.js"><link rel="prefetch" href="/assets/js/63.8b5c4639.js"><link rel="prefetch" href="/assets/js/64.23f5b95c.js"><link rel="prefetch" href="/assets/js/65.4985d24b.js"><link rel="prefetch" href="/assets/js/66.f3358479.js"><link rel="prefetch" href="/assets/js/67.a404dc7c.js"><link rel="prefetch" href="/assets/js/68.4867dcf5.js"><link rel="prefetch" href="/assets/js/69.e6533bdf.js"><link rel="prefetch" href="/assets/js/7.89860eb3.js"><link rel="prefetch" href="/assets/js/70.d6581cb5.js"><link rel="prefetch" href="/assets/js/71.46199338.js"><link rel="prefetch" href="/assets/js/72.c74e5c3e.js"><link rel="prefetch" href="/assets/js/73.a9a3aa2f.js"><link rel="prefetch" href="/assets/js/74.d832c7a1.js"><link rel="prefetch" href="/assets/js/75.337ed40c.js"><link rel="prefetch" href="/assets/js/76.39b2c04e.js"><link rel="prefetch" href="/assets/js/77.01ba5622.js"><link rel="prefetch" href="/assets/js/78.b211f414.js"><link rel="prefetch" href="/assets/js/79.1fe9a2c0.js"><link rel="prefetch" href="/assets/js/8.54c6c177.js"><link rel="prefetch" href="/assets/js/80.ecf976f6.js"><link rel="prefetch" href="/assets/js/81.8c22e86c.js"><link rel="prefetch" href="/assets/js/82.79d6812b.js"><link rel="prefetch" href="/assets/js/83.e8b79a8d.js"><link rel="prefetch" href="/assets/js/84.46bbb939.js"><link rel="prefetch" href="/assets/js/85.360cccc1.js"><link rel="prefetch" href="/assets/js/86.99309a51.js"><link rel="prefetch" href="/assets/js/87.eb2628ba.js"><link rel="prefetch" href="/assets/js/88.48c3b7aa.js"><link rel="prefetch" href="/assets/js/89.b3d56b26.js"><link rel="prefetch" href="/assets/js/9.061a1f3f.js"><link rel="prefetch" href="/assets/js/90.530573e8.js"><link rel="prefetch" href="/assets/js/91.0b43a13c.js"><link rel="prefetch" href="/assets/js/92.5978b6b1.js"><link rel="prefetch" href="/assets/js/93.0152dcb5.js"><link rel="prefetch" href="/assets/js/94.e6697216.js"><link rel="prefetch" href="/assets/js/95.402c7586.js"><link rel="prefetch" href="/assets/js/96.a8fe31d7.js"><link rel="prefetch" href="/assets/js/97.1f54b8d2.js"><link rel="prefetch" href="/assets/js/98.d3133590.js"><link rel="prefetch" href="/assets/js/99.0e23148c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ef7cd65c.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container have-rightmenu have-body-img"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="KNOTE" class="logo"> <span class="site-name can-hide">KNOTE</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/note/" class="nav-link">导航</a></div><div class="nav-item"><a href="/whell/web/" class="nav-link">收藏</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div> <a href="https://github.com/micolor" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.png"> <div class="blogger-info"><h3>AnWen</h3> <span>积跬步以至千里</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/note/" class="nav-link">导航</a></div><div class="nav-item"><a href="/whell/web/" class="nav-link">收藏</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/about/" class="nav-link">关于</a></li></ul></div></div> <a href="https://github.com/micolor" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>sentinel</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bccbb6/#_1、什么是sentinel" class="sidebar-link">1、什么是Sentinel:</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#sentinel-具有以下特征" class="sidebar-link">Sentinel 具有以下特征:</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#sentinel主要特性" class="sidebar-link">Sentinel主要特性：</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#sentinel-的使用" class="sidebar-link">Sentinel 的使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#sentinel中的管理控制台" class="sidebar-link">Sentinel中的管理控制台</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#获取-sentinel-控制台" class="sidebar-link">获取 Sentinel 控制台</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#sentinel服务启动" class="sidebar-link">sentinel服务启动</a></li></ul></li><li><a href="/pages/bccbb6/#启动-sentinel" class="sidebar-link">启动 sentinel</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#客户端能接入控制台" class="sidebar-link">客户端能接入控制台</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#sentinel与hystrix的区别" class="sidebar-link">Sentinel与Hystrix的区别</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#定义资源" class="sidebar-link">定义资源</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#资源注解-sentinelresource" class="sidebar-link">资源注解@SentinelResource</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#sentinelresource-注解" class="sidebar-link">@SentinelResource 注解</a></li><li class="sidebar-sub-header level4"><a href="/pages/bccbb6/#fallback-函数签名和位置要求" class="sidebar-link">fallback 函数签名和位置要求：</a></li><li class="sidebar-sub-header level4"><a href="/pages/bccbb6/#defaultfallback-函数签名要求" class="sidebar-link">defaultFallback 函数签名要求：</a></li></ul></li><li><a href="/pages/bccbb6/#定义规则" class="sidebar-link">定义规则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#什么是熔断降级" class="sidebar-link">什么是熔断降级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#熔断降级规则" class="sidebar-link">熔断降级规则</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#几种降级策略" class="sidebar-link">几种降级策略</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#熔断降级代码实现" class="sidebar-link">熔断降级代码实现</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#控制台降级规则" class="sidebar-link">控制台降级规则</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#与hystrix的熔断对比" class="sidebar-link">与Hystrix的熔断对比：</a></li></ul></li><li><a href="/pages/bccbb6/#基本的参数" class="sidebar-link">基本的参数</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#流控的几种strategy" class="sidebar-link">流控的几种`strategy`：</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#直接失败模式" class="sidebar-link">直接失败模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#使用api进行资源定义" class="sidebar-link">使用API进行资源定义</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#代码限流规则" class="sidebar-link">代码限流规则</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#网页限流规则配置" class="sidebar-link">网页限流规则配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#测试" class="sidebar-link">测试</a></li></ul></li><li><a href="/pages/bccbb6/#关联模式" class="sidebar-link">关联模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#使用注解进行资源定义" class="sidebar-link">使用注解进行资源定义</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#代码配置关联限流规则" class="sidebar-link">代码配置关联限流规则</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#网页限流规则配置-2" class="sidebar-link">网页限流规则配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#测试-2" class="sidebar-link">测试</a></li></ul></li><li><a href="/pages/bccbb6/#warm-up-预热-模式" class="sidebar-link">Warm up（预热）模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#使用注解定义资源" class="sidebar-link">使用注解定义资源</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#代码限流规则-2" class="sidebar-link">代码限流规则</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#网页限流规则配置-3" class="sidebar-link">网页限流规则配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#通过jmeter进行测试" class="sidebar-link">通过jmeter进行测试</a></li></ul></li><li><a href="/pages/bccbb6/#排队等待模式" class="sidebar-link">排队等待模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#示例" class="sidebar-link">示例</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#使用注解定义资源-2" class="sidebar-link">使用注解定义资源</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#代码限流规则-3" class="sidebar-link">代码限流规则</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#网页限流规则配置-4" class="sidebar-link">网页限流规则配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#通过jmeter进行测试-2" class="sidebar-link">通过jmeter进行测试</a></li></ul></li><li><a href="/pages/bccbb6/#热点规则-paramflowrule" class="sidebar-link">热点规则 (ParamFlowRule)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#自定义资源" class="sidebar-link">自定义资源</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#限流规则代码" class="sidebar-link">限流规则代码：</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#网页限流规则配置-5" class="sidebar-link">网页限流规则配置</a></li></ul></li><li><a href="/pages/bccbb6/#系统保护的目的" class="sidebar-link">系统保护的目的</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#系统保护规则的应用" class="sidebar-link">系统保护规则的应用</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#网页限流规则配置-6" class="sidebar-link">网页限流规则配置</a></li></ul></li><li><a href="/pages/bccbb6/#访问控制规则-authorityrule" class="sidebar-link">访问控制规则 (AuthorityRule)</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/bccbb6/#resource" class="sidebar-link">Resource</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#context" class="sidebar-link">Context</a></li><li class="sidebar-sub-header level4"><a href="/pages/bccbb6/#context的创建与销毁" class="sidebar-link">Context的创建与销毁</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#entry" class="sidebar-link">Entry</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#defaultnode" class="sidebar-link">DefaultNode</a></li><li class="sidebar-sub-header level3"><a href="/pages/bccbb6/#构造树干" class="sidebar-link">构造树干</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><!----> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/micolor" target="_blank" title="作者" class="beLink" data-v-06225672>AnWen</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-12-10</a></div> <div title="分类" class="date iconfont icon-wenjian" data-v-06225672><a href="/categories/?category=%E7%AC%94%E8%AE%B0" data-v-06225672>笔记 </a><a href="/categories/?category=spring" data-v-06225672>spring </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">sentinel<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="_1-sentinel-基本概念"><a href="#_1-sentinel-基本概念" class="header-anchor">#</a> 1 sentinel 基本概念</h1> <blockquote><p>开发的原因，需要对吞吐量（TPS）、QPS、并发数、响应时间（RT）几个概念做下了解，查自百度百科，记录如下：</p> <ol><li><p>响应时间(RT)</p> <p>响应时间是指系统对请求作出响应的时间。直观上看，这个指标与人对软件性能的主观感受是非常一致的，因为它完整地记录了整个计算机系统处理请求的时间。由于一个系统通常会提供许多功能，而不同功能的处理逻辑也千差万别，因而不同功能的响应时间也不尽相同，甚至同一功能在不同输入数据的情况下响应时间也不相同。所以，在讨论一个系统的响应时间时，人们通常是指该系统所有功能的平均时间或者所有功能的最大响应时间。当然，往往也需要对每个或每组功能讨论其平均响应时间和最大响应时间。对于单机的没有并发操作的应用系统而言，人们普遍认为响应时间是一个合理且准确的性能指标。需要指出的是，响应时间的绝对值并不能直接反映软件的性能的高低，软件性能的高低实际上取决于用户对该响应时间的接受程度。对于一个游戏软件来说，响应时间小于100毫秒应该是不错的，响应时间在1秒左右可能属于勉强可以接受，如果响应时间达到3秒就完全难以接受了。而对于编译系统来说，完整编译一个较大规模软件的源代码可能需要几十分钟甚至更长时间，但这些响应时间对于用户来说都是可以接受的。</p></li> <li><p>吞吐量(Throughput)</p></li></ol> <p>吞吐量是指系统在单位时间内处理请求的数量。对于无并发的应用系统而言，吞吐量与响应时间成严格的反比关系，实际上此时吞吐量就是响应时间的倒数。前面已经说过，对于单用户的系统，响应时间（或者系统响应时间和应用延迟时间）可以很好地度量系统的性能，但对于并发系统，通常需要用吞吐量作为性能指标。对于一个多用户的系统，如果只有一个用户使用时系统的平均响应时间是t，当有你n个用户使用时，每个用户看到的响应时间通常并不是n×t，而往往比n×t小很多（当然，在某些特殊情况下也可能比n×t大，甚至大很多）。这是因为处理每个请求需要用到很多资源，由于每个请求的处理过程中有许多不走难以并发执行，这导致在具体的一个时间点，所占资源往往并不多。也就是说在处理单个请求时，在每个时间点都可能有许多资源被闲置，当处理多个请求时，如果资源配置合理，每个用户看到的平均响应时间并不随用户数的增加而线性增加。实际上，不同系统的平均响应时间随用户数增加而增长的速度也不大相同，这也是采用吞吐量来度量并发系统的性能的主要原因。一般而言，吞吐量是一个比较通用的指标，两个具有不同用户数和用户使用模式的系统，如果其最大吞吐量基本一致，则可以判断两个系统的处理能力基本一致。</p> <ol start="3"><li><p>并发用户数</p> <p>并发用户数是指系统可以同时承载的正常使用系统功能的用户的数量。与吞吐量相比，并发用户数是一个更直观但也更笼统的性能指标。实际上，并发用户数是一个非常不准确的指标，因为用户不同的使用模式会导致不同用户在单位时间发出不同数量的请求。一网站系统为例，假设用户只有注册后才能使用，但注册用户并不是每时每刻都在使用该网站，因此具体一个时刻只有部分注册用户同时在线，在线用户就在浏览网站时会花很多时间阅读网站上的信息，因而具体一个时刻只有部分在线用户同时向系统发出请求。这样，对于网站系统我们会有三个关于用户数的统计数字：注册用户数、在线用户数和同时发请求用户数。由于注册用户可能长时间不登陆网站，使用注册用户数作为性能指标会造成很大的误差。而在线用户数和同事发请求用户数都可以作为性能指标。相比而言，以在线用户作为性能指标更直观些，而以同时发请求用户数作为性能指标更准确些。</p></li> <li><p>QPS每秒查询率(Query Per Second)</p> <p>每秒查询率QPS是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准，在因特网上，作为域名系统服务器的机器的性能经常用每秒查询率来衡量。对应fetches/sec，即每秒的响应请求数，也即是最大吞吐能力。 （看来是类似于TPS，只是应用于特定场景的吞吐量）</p></li></ol></blockquote> <h2 id="_1、什么是sentinel"><a href="#_1、什么是sentinel" class="header-anchor">#</a> 1、什么是Sentinel:</h2> <p>Sentinel是阿里开源的项目，提供了流量控制、熔断降级、系统负载保护等多个维度来保障服务之间的稳定性。
官网：https://github.com/alibaba/Sentinel/wiki</p> <p>2012年，Sentinel诞生于阿里巴巴，其主要目标是流量控制。2013-2017年，Sentinel迅速发展，并成为阿里巴巴所有微服务的基本组成部分。 它已在6000多个应用程序中使用，涵盖了几乎所有核心电子商务场景。2018年，Sentinel演变为一个开源项目。2020年，Sentinel Golang发布。</p> <h2 id="sentinel-具有以下特征"><a href="#sentinel-具有以下特征" class="header-anchor">#</a> <strong>Sentinel 具有以下特征:</strong></h2> <p><strong>丰富的应用场景</strong> ：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即
突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。
<strong>完备的实时监控</strong> ：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机
器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。
<strong>广泛的开源生态</strong> ：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring
Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入Sentinel。</p> <p><strong>完善的 SPI 扩展点</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快
速地定制逻辑。例如定制规则管理、适配动态数据源等。</p> <p><strong>Sentinel的生态圈</strong></p> <p><a href="https://pics1.baidu.com/feed/500fd9f9d72a6059c55d49a66cf6bb9d023bba02.png?token=14715c498bc885222d716066ff4a15c0" target="_blank" rel="noopener noreferrer"><img src="https://pics1.baidu.com/feed/500fd9f9d72a6059c55d49a66cf6bb9d023bba02.png?token=14715c498bc885222d716066ff4a15c0" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="sentinel主要特性"><a href="#sentinel主要特性" class="header-anchor">#</a> Sentinel主要特性：</h2> <p><a href="https://img-blog.csdnimg.cn/20200529140109886.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQyNDM1OQ==,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20200529140109886.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQyNDM1OQ==,size_16,color_FFFFFF,t_70" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>关于Sentinel与Hystrix的区别见：https://yq.aliyun.com/articles/633786/</p> <p>到这已经学习Sentinel的基本的使用，在很多的特性和Hystrix有很多类似的功能。以下是Sentinel和Hystrix的对比。</p> <h2 id="sentinel-的使用"><a href="#sentinel-的使用" class="header-anchor">#</a> Sentinel 的使用</h2> <p><strong>Sentinel 的使用可以分为两个部分:</strong></p> <ul><li>控制台（Dashboard）：控制台主要负责管理推送规则、监控、集群限流分配管理、机器发现等。</li> <li>核心库（Java 客户端）：不依赖任何框架/库，能够运行于 Java 7 及以上的版本的运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</li></ul> <p>在这里我们看下控制台的使用</p> <h3 id="sentinel中的管理控制台"><a href="#sentinel中的管理控制台" class="header-anchor">#</a> <strong>Sentinel中的管理控制台</strong></h3> <h3 id="获取-sentinel-控制台"><a href="#获取-sentinel-控制台" class="header-anchor">#</a> 获取 Sentinel 控制台</h3> <p>您可以从 <a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener noreferrer">release 页面<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 下载最新版本的控制台 jar 包。</p> <p>您也可以从最新版本的源码自行构建 Sentinel 控制台：</p> <ul><li>下载 <a href="https://github.com/alibaba/Sentinel/tree/master/sentinel-dashboard" target="_blank" rel="noopener noreferrer">控制台<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 工程</li> <li>使用以下命令将代码打包成一个 fat jar: <code>mvn clean package</code></li></ul> <h3 id="sentinel服务启动"><a href="#sentinel服务启动" class="header-anchor">#</a> sentinel服务启动</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">java</span>  <span class="token parameter variable">-server</span> <span class="token parameter variable">-Xms64m</span> <span class="token parameter variable">-Xmx256m</span>  <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8849</span> <span class="token parameter variable">-Dcsp.sentinel.dashboard.server</span><span class="token operator">=</span>localhost:8849 <span class="token parameter variable">-Dproject.name</span><span class="token operator">=</span>sentinel-dashboard <span class="token parameter variable">-jar</span> /work/sentinel-dashboard-1.7.1.jar 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>开机启动：启动命令可以加入到启动的 rc.local 配置文件， 之后做到开机启动</p> <h2 id="启动-sentinel"><a href="#启动-sentinel" class="header-anchor">#</a> 启动 sentinel</h2> <p>除了流量控制以外，对调用链路中不稳定的资源进行熔断降级也是保障高可用的重要措施之一。</p> <p>由于调用关系的复杂性，如果调用链路中的某个资源不稳定，最终会导致请求发生堆积。Sentinel 熔断降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误。当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断（默认行为是抛出 DegradeException）。</p> <p>关于熔断降级的介绍见：Sentinel熔断降级。</p> <p>下面就使用基于注解的方式实现Sentinel的熔断降级的demo。</p> <blockquote><p><strong>注意</strong>：启动 Sentinel 控制台需要 JDK 版本为 1.8 及以上版本。</p></blockquote> <p>使用如下命令启动控制台：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">nohup</span> <span class="token function">java</span>  <span class="token parameter variable">-server</span> <span class="token parameter variable">-Xms64m</span> <span class="token parameter variable">-Xmx256m</span>  <span class="token parameter variable">-Dserver.port</span><span class="token operator">=</span><span class="token number">8849</span> <span class="token parameter variable">-Dcsp.sentinel.dashboard.server</span><span class="token operator">=</span>localhost:8849 <span class="token parameter variable">-Dproject.name</span><span class="token operator">=</span>sentinel-dashboard <span class="token parameter variable">-jar</span> /work/sentinel-dashboard-1.7.1.jar <span class="token operator">&amp;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中 -Dserver.port=8849用于指定 Sentinel 控制台端口为 8849 ， 这个端口可以按需指定。</p> <p>从 Sentinel 1.6.0 起，Sentinel 控制台引入基本的<strong>登录</strong>功能，默认用户名和密码都是 <code>sentinel</code>。可以参考 <a href="https://github.com/alibaba/Sentinel/wiki/%E6%8E%A7%E5%88%B6%E5%8F%B0#%E9%89%B4%E6%9D%83" target="_blank" rel="noopener noreferrer">鉴权模块文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 配置用户名和密码。</p> <blockquote><p>注：若您的应用为 Spring Boot 或 Spring Cloud 应用，您可以通过 Spring 配置文件来指定配置，详情请参考 <a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba/wiki/Sentinel" target="_blank" rel="noopener noreferrer">Spring Cloud Alibaba Sentinel 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。（1）获取 Sentinel 控制台
您可以从官方 网站中 下载最新版本的控制台 jar 包，下载地址如下：</p></blockquote> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>https://github.com/alibaba/Sentinel/releases/download/1.6.3/sentinel-dashboard-1.7.1.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>（2）启动
使用如下命令启动控制台：
其中 - Dserver.port=8888 用于指定 Sentinel 控制台端口为 8888 。
从 Sentinel 1.6.0 起，Sentinel 控制台引入基本的登录功能，默认用户名和密码都是 sentinel 。可以参考 鉴权模块文档 配置用户名和密码。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@192 ~<span class="token punctuation">]</span><span class="token comment"># java -Dserver.port=8888 -Dcsp.sentinel.dashboard.server=localhost:8888 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.6.3.jar</span>
INFO: log base <span class="token function">dir</span> is: /root/logs/csp/
INFO: log name use pid is: <span class="token boolean">false</span>

  <span class="token builtin class-name">.</span>   ____          _            __ _ _
 /<span class="token punctuation">\</span><span class="token punctuation">\</span> / ___<span class="token string">'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '</span>_ <span class="token operator">|</span> <span class="token string">'_| | '</span>_ <span class="token punctuation">\</span>/ _` <span class="token operator">|</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span>
 <span class="token punctuation">\</span><span class="token punctuation">\</span>/  ___<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span>_<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_<span class="token operator">|</span> <span class="token operator">|</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
  '  <span class="token operator">|</span>____<span class="token operator">|</span> .__<span class="token operator">|</span>_<span class="token operator">|</span> <span class="token operator">|</span>_<span class="token operator">|</span>_<span class="token operator">|</span> <span class="token operator">|</span>_<span class="token punctuation">\</span>__, <span class="token operator">|</span> / / / /
 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">|</span>_<span class="token operator">|</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">|</span>___/<span class="token operator">=</span>/_/_/_/
 :: Spring Boot ::        <span class="token punctuation">(</span>v2.0.5.RELEASE<span class="token punctuation">)</span>

<span class="token number">2020</span>-02-08 <span class="token number">13</span>:07:29.316  INFO <span class="token number">114031</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> c.a.c.s.dashboard.DashboardApplication   <span class="token builtin class-name">:</span> Starting DashboardApplication on <span class="token number">192.168</span>.180.137 with PID <span class="token number">114031</span> <span class="token punctuation">(</span>/root/sentinel-dashboard-1.6.3.jar started by root <span class="token keyword">in</span> /root<span class="token punctuation">)</span>
<span class="token number">2020</span>-02-08 <span class="token number">13</span>:07:29.319  INFO <span class="token number">114031</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> c.a.c.s.dashboard.DashboardApplication   <span class="token builtin class-name">:</span> No active profile set, falling back to default profiles: default
<span class="token number">2020</span>-02-08 <span class="token number">13</span>:07:29.456  INFO <span class="token number">114031</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> ConfigServletWebServerApplicationContext <span class="token builtin class-name">:</span> Refreshing org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext@59690aa4: startup <span class="token function">date</span> <span class="token punctuation">[</span>Sat Feb 08 <span class="token number">13</span>:07:29 CST <span class="token number">2020</span><span class="token punctuation">]</span><span class="token punctuation">;</span> root of context hierarchy
<span class="token number">2020</span>-02-08 <span class="token number">13</span>:07:33.783  INFO <span class="token number">114031</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> o.s.b.w.embedded.tomcat.TomcatWebServer  <span class="token builtin class-name">:</span> Tomcat initialized with port<span class="token punctuation">(</span>s<span class="token punctuation">)</span>: <span class="token number">8888</span> <span class="token punctuation">(</span>http<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>启动 Sentinel 控制台需要 JDK 版本为 1.8 及以上版本。</p> <p><a href="https://img2018.cnblogs.com/i-beta/1829785/202002/1829785-20200208130957043-1991794415.png" target="_blank" rel="noopener noreferrer"><img src="https://img2018.cnblogs.com/i-beta/1829785/202002/1829785-20200208130957043-1991794415.png" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>查看机器列表以及健康情况</strong>
默认情况下Sentinel 会在客户端首次调用的时候进行初始化，开始向控制台发送心跳包。也可以配置
sentinel.eager=true ,取消Sentinel控制台懒加载。
打开浏览器即可展示Sentinel的管理控制台</p> <p><a href="https://img2018.cnblogs.com/i-beta/1829785/202002/1829785-20200208133653172-1748300698.png" target="_blank" rel="noopener noreferrer"><img src="https://img2018.cnblogs.com/i-beta/1829785/202002/1829785-20200208133653172-1748300698.png" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="客户端能接入控制台"><a href="#客户端能接入控制台" class="header-anchor">#</a> <strong>客户端能接入控制台</strong></h2> <p>控制台启动后，客户端需要按照以下步骤接入到控制台。</p> <p>父工程引入 alibaba实现的SpringCloud</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>Greenwich.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>子工程中引入 sentinel</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>（ 2）配置启动参数
在工程的application.yml中添加Sentinel 控制台配置信息</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> 192.168.180.137<span class="token punctuation">:</span><span class="token number">8888</span>   <span class="token comment">#sentinel控制台的请求地址</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这里的 spring.cloud.sentinel.transport.dashboard 配置控制台的请求路径。</p> <h2 id="sentinel与hystrix的区别"><a href="#sentinel与hystrix的区别" class="header-anchor">#</a> Sentinel与Hystrix的区别</h2> <p><a href="https://yqfile.alicdn.com/eb621bf3d522b53ed4704290db32e254130ba9a2.png" target="_blank" rel="noopener noreferrer"><img src="https://yqfile.alicdn.com/eb621bf3d522b53ed4704290db32e254130ba9a2.png" alt="image"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>迁移方案</strong>
Sentinel 官方提供了详细的由Hystrix 迁移到Sentinel 的方法</p> <p><a href="https://img2018.cnblogs.com/i-beta/1829785/202002/1829785-20200208125155175-979540425.png" target="_blank" rel="noopener noreferrer"><img src="https://img2018.cnblogs.com/i-beta/1829785/202002/1829785-20200208125155175-979540425.png" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="_2-使用-sentinel-来进行熔断与限流"><a href="#_2-使用-sentinel-来进行熔断与限流" class="header-anchor">#</a> 2 使用 Sentinel 来进行熔断与限流</h1> <p>Sentinel 可以简单的分为 Sentinel 核心库和 Dashboard。核心库不依赖 Dashboard，但是结合
Dashboard 可以取得最好的效果。
使用 Sentinel 来进行熔断保护，主要分为几个步骤:</p> <ol><li><p>定义资源</p> <blockquote><p>资源：可以是任何东西，一个服务，服务里的方法，甚至是一段代码。</p></blockquote></li> <li><p>定义规则</p> <blockquote><p>规则：Sentinel 支持以下几种规则：流量控制规则、熔断降级规则、系统保护规则、来源访问控制规则
和 热点参数规则。</p></blockquote></li> <li><p>检验规则是否生效</p></li></ol> <p>Sentinel 的所有规则都可以在内存态中动态地查询及修改，修改之后立即生效. 先把可能需要保护的资源定义好，之后再配置规则。</p> <p>也可以理解为，只要有了资源，我们就可以在任何时候灵活地定义各种流量控制规则。在编码的时候，只需要考虑这个代码是否需要保护，如果需要保
护，就将之定义为一个资源。</p> <h2 id="定义资源"><a href="#定义资源" class="header-anchor">#</a> 定义资源</h2> <p><strong>资源</strong>是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它应用提供的服务，RPC接口方法，甚至可以是一段代码。</p> <p>只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。</p> <p>把需要控制流量的代码用 Sentinel的关键代码 SphU.entry(&quot;资源名&quot;) 和 entry.exit() 包围起来即可。</p> <p>实例代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 定义一个sentinel保护的资源，名称为test-sentinel-api</span>
        entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 模拟执行被保护的业务逻辑耗时</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果被保护的资源被限流或者降级了，就会抛出BlockException</span>
        log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;资源被限流或降级了&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;资源被限流或降级了&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;发生InterruptedException&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            entry<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>在下面的例子中， 用 try-with-resources 来定义资源。参考代码如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 配置规则.</span>
    <span class="token function">initFlowRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1.5.0 版本开始可以直接利用 try-with-resources 特性</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 被保护的逻辑</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理被流控的逻辑</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;blocked!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="资源注解-sentinelresource"><a href="#资源注解-sentinelresource" class="header-anchor">#</a> 资源注解@SentinelResource</h3> <p>也可以使用Sentinel提供的注解@SentinelResource来定义资源，实例如下:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">helloWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 资源中的逻辑</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="sentinelresource-注解"><a href="#sentinelresource-注解" class="header-anchor">#</a> @SentinelResource 注解</h3> <blockquote><p>注意：注解方式埋点不支持 private 方法。</p></blockquote> <p><code>@SentinelResource</code> 用于定义资源，并提供可选的异常处理和 fallback 配置项。</p> <p><code>@SentinelResource</code> 注解包含以下属性：</p> <ul><li>value：资源名称，必需项（不能为空）</li> <li>entryType：entry 类型，可选项（默认为 EntryType.OUT）</li> <li>blockHandler / blockHandlerClass:</li></ul> <p>blockHandler 对应处理 BlockException的函数名称，可选项。blockHandler 函数访问范围需要是 public，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 BlockException。blockHandler 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 blockHandlerClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。</p> <ul><li><p>fallback /fallbackClass</p> <p>：fallback 函数名称，可选项，用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了exceptionsToIgnore里面排除掉的异常类型）进行处理。</p></li> <li><p>defaultFallback</p> <p>（since 1.6.0）：默认的 fallback 函数名称，可选项，通常用于通用的 fallback 逻辑（即可以用于很多服务或方法）。默认 fallback 函数可以针对所有类型的异常（除了exceptionsToIgnore里面排除掉的异常类型）进行处理。若同时配置了 fallback 和 defaultFallback，则只有 fallback 会生效。</p></li></ul> <h4 id="fallback-函数签名和位置要求"><a href="#fallback-函数签名和位置要求" class="header-anchor">#</a> fallback 函数签名和位置要求：</h4> <ul><li>返回值类型必须与原函数返回值类型一致；</li> <li>方法参数列表需要和原函数一致，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常。</li> <li>fallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 fallbackClass为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。</li></ul> <h4 id="defaultfallback-函数签名要求"><a href="#defaultfallback-函数签名要求" class="header-anchor">#</a> defaultFallback 函数签名要求：</h4> <ul><li>返回值类型必须与原函数返回值类型一致；</li> <li>方法参数列表需要为空，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常。</li> <li>defaultFallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 fallbackClass 为对应的类的 Class 对象，注意对应的函数必需为 static 函数，否则无法解析。</li> <li>exceptionsToIgnore（since 1.6.0）：用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。</li></ul> <h2 id="定义规则"><a href="#定义规则" class="header-anchor">#</a> 定义规则</h2> <p>规则主要有流控规则、 熔断降级规则、系统规则、权限规则、热点参数规则等：</p> <p>一段硬编码的方式定义流量控制规则如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initSystemRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SystemRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rule<span class="token punctuation">.</span><span class="token function">setHighestSystemLoad</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SystemRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>加载规则：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改流控规则</span>
<span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改降级规则</span>
<span class="token class-name">SystemRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改系统规则</span>
<span class="token class-name">AuthorityRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">&gt;</span></span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 修改授权规则</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h1 id="_3-sentinel-熔断降级"><a href="#_3-sentinel-熔断降级" class="header-anchor">#</a> 3 sentinel 熔断降级</h1> <h2 id="什么是熔断降级"><a href="#什么是熔断降级" class="header-anchor">#</a> 什么是熔断降级</h2> <p>熔断降级对调用链路中不稳定的资源进行熔断降级是保障高可用的重要措施之一。</p> <p>由于调用关系的复杂性，如果调用链路中的某个资源不稳定，最终会导致请求发生堆积。Sentinel 熔断降级会在调用链路中某个资源出现不稳定状态时（例如调用超时或异常比例升高），对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联错误。当资源被降级后，在接下来的降级时间窗口之内，对该资源的调用都自动熔断（默认行为是抛出 DegradeException）</p> <h3 id="熔断降级规则"><a href="#熔断降级规则" class="header-anchor">#</a> 熔断降级规则</h3> <p>熔断降级规则包含下面几个重要的属性：</p> <table><thead><tr><th style="text-align:left;"></th> <th style="text-align:left;"></th> <th style="text-align:left;"></th></tr></thead> <tbody><tr><td style="text-align:left;">Field</td> <td style="text-align:left;">说明</td> <td style="text-align:left;">默认值</td></tr> <tr><td style="text-align:left;">resource</td> <td style="text-align:left;">资源名，即规则的作用对象</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">grade</td> <td style="text-align:left;">熔断策略，支持慢调用比例/异常比例/异常数策略</td> <td style="text-align:left;">慢调用比例</td></tr> <tr><td style="text-align:left;">count</td> <td style="text-align:left;">慢调用比例模式下为慢调用临界 RT（超出该值计为慢调用）；异常比例/异常数模式下为对应的阈值</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">timeWindow</td> <td style="text-align:left;">熔断时长，单位为 s</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">minRequestAmount</td> <td style="text-align:left;">熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断（1.7.0 引入）</td> <td style="text-align:left;">5</td></tr> <tr><td style="text-align:left;">statIntervalMs</td> <td style="text-align:left;">统计时长（单位为 ms），如 60*1000 代表分钟级（1.8.0 引入）</td> <td style="text-align:left;">1000 ms</td></tr> <tr><td style="text-align:left;">slowRatioThreshold</td> <td style="text-align:left;">慢调用比例阈值，仅慢调用比例模式有效（1.8.0 引入）</td> <td style="text-align:left;"></td></tr></tbody></table> <h3 id="几种降级策略"><a href="#几种降级策略" class="header-anchor">#</a> 几种降级策略</h3> <p>我们通常用以下几种降级策略：</p> <ul><li><p>平均响应时间 (DEGRADE_GRADE_RT)：</p> <p>当资源的平均响应时间超过阈值（DegradeRule 中的 count，以 ms 为单位）之后，资源进入准降级状态。如果接下来 1s 内持续进入 5 个请求（即 QPS &gt;= 5），它们的 RT 都持续超过这个阈值，那么在接下的时间窗口（DegradeRule 中的 timeWindow，以 s 为单位）之内，对这个方法的调用都会自动地熔断（抛出 DegradeException）。</p> <blockquote><p>注意 Sentinel 默认统计的 RT 上限是 4900 ms，超出此阈值的都会算作 4900 ms，若需要变更此上限可以通过启动配置项 -Dcsp.sentinel.statistic.max.rt=xxx 来配置。</p></blockquote></li> <li><p>异常比例 (DEGRADE_GRADE_EXCEPTION_RATIO)：</p> <p>当资源的每秒异常总数占通过量的比值超过阈值（DegradeRule 中的 count）之后，资源进入降级状态，即在接下的时间窗口（DegradeRule 中的 timeWindow，以 s 为单位）之内，对这个方法的调用都会自动地返回。</p> <blockquote><p>异常比率的阈值范围是 [0.0, 1.0]，代表 0% - 100%。</p></blockquote></li> <li><p>异常数 (DEGRADE_GRADE_EXCEPTION_COUNT)：</p> <p>当资源近 1 分钟的异常数目超过阈值之后会进行熔断。</p> <blockquote><p>注意由于统计时间窗口是分钟级别的，若 timeWindow 小于 60s，则结束熔断状态后仍可能再进入熔断状态。</p></blockquote></li></ul> <h3 id="熔断降级代码实现"><a href="#熔断降级代码实现" class="header-anchor">#</a> 熔断降级代码实现</h3> <p>可以通过调用 DegradeRuleManager.loadRules() 方法来用硬编码的方式定义流量控制规则。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initSentinelRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//熔断规则： 5s内调用接口出现异常次数超过5的时候, 进行熔断</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span></span> degradeRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DegradeRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DegradeRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">&quot;queryGoodsInfo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    rule<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">DEGRADE_GRADE_EXCEPTION_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//熔断规则</span>
    rule<span class="token punctuation">.</span><span class="token function">setTimeWindow</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    degradeRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>degradeRules<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="控制台降级规则"><a href="#控制台降级规则" class="header-anchor">#</a> 控制台降级规则</h3> <p>配置</p> <p><a href="https://img-blog.csdnimg.cn/20210116194700580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20210116194700580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>参数</p> <table><thead><tr><th style="text-align:left;">Field</th> <th style="text-align:left;">说明</th> <th style="text-align:left;">默认值</th></tr></thead> <tbody><tr><td style="text-align:left;">resource</td> <td style="text-align:left;">资源名，即限流规则的作用对象</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">count</td> <td style="text-align:left;">阈值</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">grade</td> <td style="text-align:left;">降级模式，根据 RT 降级还是根据异常比例降级</td> <td style="text-align:left;">RT</td></tr> <tr><td style="text-align:left;">timeWindow</td> <td style="text-align:left;">降级的时间，单位为 s</td> <td style="text-align:left;"></td></tr></tbody></table> <h3 id="与hystrix的熔断对比"><a href="#与hystrix的熔断对比" class="header-anchor">#</a> 与Hystrix的熔断对比：</h3> <p>Hystrix常用的线程池隔离会造成线程上下切换的overhead比较大；Hystrix使用的信号量隔离对某个资源调用的并发数进行控制，效果不错，但是无法对慢调用进行自动降级；</p> <p>Sentinel通过并发线程数的流量控制提供信号量隔离的功能；此外，Sentinel支持的熔断降级维度更多，可对多种指标进行流控、熔断，且提供了实时监控和控制面板，功能更为强大。</p> <h1 id="_4-sentinel-流控-限流"><a href="#_4-sentinel-流控-限流" class="header-anchor">#</a> 4 Sentinel 流控（限流）</h1> <p>流量控制(Flow Control)，原理是监控应用流量的QPS或并发线程数等指标，当达到指定阈值时对流量进行控制，避免系统被瞬时的流量高峰冲垮，保障应用高可用性。</p> <p>通过流控规则来指定允许该资源通过的请求次数，例如下面的代码定义了资源 HelloWorld 每秒最多只能通过 20 个请求。 参考的规则定义如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initFlowRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FlowRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">&quot;HelloWorld&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rule<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Set limit QPS to 20.</span>
    rule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>一条限流规则主要由下面几个因素组成，我们可以组合这些元素来实现不同的限流效果：</p> <ul><li><code>resource</code>：资源名，即限流规则的作用对象</li> <li><code>count</code>: 限流阈值</li> <li><code>grade</code>: 限流阈值类型（QPS 或并发线程数）</li> <li><code>limitApp</code>: 流控针对的调用来源，若为 <code>default</code> 则不区分调用来源</li> <li><code>strategy</code>: 调用关系限流策略</li> <li><code>controlBehavior</code>: 流量控制效果（直接拒绝、Warm Up、匀速排队）</li></ul> <h2 id="基本的参数"><a href="#基本的参数" class="header-anchor">#</a> 基本的参数</h2> <p><strong>资源名</strong>：唯一名称，默认请求路径</p> <p><strong>针对来源</strong>：Sentinel可以针对调用者进行限流，填写微服务名，默认为default(不区分来源)</p> <p><strong>阈值类型/单机阈值：</strong></p> <p>1.QPS：每秒请求数，当前调用该api的QPS到达阈值的时候进行限流</p> <p>2.线程数：当调用该api的线程数到达阈值的时候，进行限流</p> <p><strong>是否集群</strong>：是否为集群</p> <h2 id="流控的几种strategy"><a href="#流控的几种strategy" class="header-anchor">#</a> <strong>流控的几种<code>strategy</code></strong>：</h2> <p>1.直接：当api达到限流条件时，直接限流</p> <p>2.关联：当关联的资源到达阈值，就限流自己</p> <p>3.链路：只记录指定路上的流量，指定资源从入口资源进来的流量，如果达到阈值，就进行限流，api级别的限流</p> <h2 id="直接失败模式"><a href="#直接失败模式" class="header-anchor">#</a> 直接失败模式</h2> <h3 id="使用api进行资源定义"><a href="#使用api进行资源定义" class="header-anchor">#</a> 使用API进行资源定义</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> s<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">&quot;helloWord&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;Sentinel 你大爷&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;降级.系统繁忙...&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="代码限流规则"><a href="#代码限流规则" class="header-anchor">#</a> 代码限流规则</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//限流规则 QPS mode,</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FlowRule</span> rule1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rule1<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">&quot;helloWord&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// QPS控制在2以内</span>
rule1<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// QPS限流</span>
rule1<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rule1<span class="token punctuation">.</span><span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="网页限流规则配置"><a href="#网页限流规则配置" class="header-anchor">#</a> 网页限流规则配置</h3> <p>选择QPS，直接，快速失败，单机阈值为2。</p> <p>配置</p> <p>![流控规则](<a href="https://img-blog.csdnimg.cn/20210116194515175.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20210116194515175.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>参数</p> <table><thead><tr><th style="text-align:left;">Field</th> <th style="text-align:left;">说明</th> <th style="text-align:left;">默认值</th></tr></thead> <tbody><tr><td style="text-align:left;">resource</td> <td style="text-align:left;">资源名，资源名是限流规则的作用对象</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">count</td> <td style="text-align:left;">限流阈值</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">grade</td> <td style="text-align:left;">限流阈值类型，QPS 或线程数模式</td> <td style="text-align:left;">QPS 模式</td></tr> <tr><td style="text-align:left;">limitApp</td> <td style="text-align:left;">流控针对的调用来源</td> <td style="text-align:left;"><code>default</code>，代表不区分调用来源</td></tr> <tr><td style="text-align:left;">strategy</td> <td style="text-align:left;">判断的根据是资源自身，还是根据其它关联资源 (<code>refResource</code>)，还是根据链路入口</td> <td style="text-align:left;">根据资源本身</td></tr> <tr><td style="text-align:left;">controlBehavior</td> <td style="text-align:left;">流控效果（直接拒绝 / 排队等待 / 慢启动模式）</td> <td style="text-align:left;">直接拒绝</td></tr></tbody></table> <h3 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h3> <p>频繁刷新请求，1秒访问2次请求，正常，超过设置的阈值，将报默认的错误。</p> <p><a href="https://pics4.baidu.com/feed/d6ca7bcb0a46f21f736fcc3eb7e6e4660d33ae49.png?token=21c375e0121e5fac15a82a07284c66aa" target="_blank" rel="noopener noreferrer"><img src="https://pics4.baidu.com/feed/d6ca7bcb0a46f21f736fcc3eb7e6e4660d33ae49.png?token=21c375e0121e5fac15a82a07284c66aa" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>再次的1秒访问2次请求，访问正常。超过2次，访问异常</p> <h2 id="关联模式"><a href="#关联模式" class="header-anchor">#</a> 关联模式</h2> <p>调用关系包括调用方、被调用方；一个方法又可能会调用其它方法，形成一个调用链路的层次关系。Sentinel 通过 <code>NodeSelectorSlot</code> 建立不同资源间的调用的关系，并且通过 <code>ClusterBuilderSlot</code> 记录每个资源的实时统计信息。</p> <p>当两个资源之间具有资源争抢或者依赖关系的时候，这两个资源便具有了关联。</p> <p>比如对数据库同一个字段的读操作和写操作存在争抢，读的速度过高会影响写得速度，写的速度过高会影响读的速度。如果放任读写操作争抢资源，则争抢本身带来的开销会降低整体的吞吐量。可使用关联限流来避免具有关联关系的资源之间过度的争抢.</p> <p>举例来说，<code>read_db</code> 和 <code>write_db</code> 这两个资源分别代表数据库读写，我们可以给 <code>read_db</code> 设置限流规则来达到写优先的目的。具体的方法：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>设置 `strategy` 为 `RuleConstant.STRATEGY_RELATE` 
设置 `refResource` 为 `write_db`。
这样当写库操作过于频繁时，读数据的请求会被限流。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>还有一个例子，电商的 下订单 和 支付两个操作，需要优先保障 支付， 可以根据 支付接口的 流量阈值，来对订单接口进行限制，从而保护支付的目的。</p> <h3 id="使用注解进行资源定义"><a href="#使用注解进行资源定义" class="header-anchor">#</a> 使用注解进行资源定义</h3> <p>添加2个请求</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;test1&quot;</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;exceptionHandler&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;...test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;-------hello baby，i am test1&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Block 异常处理函数，参数最后多一个 BlockException，其余与原函数一致.</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">exceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> ex<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Do some log here.</span>
    ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;...exceptionHandler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;error: test1  is not OK&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;test1_ref&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test1_ref&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;...test1_related&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;-------hello baby，i am test1_ref&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="代码配置关联限流规则"><a href="#代码配置关联限流规则" class="header-anchor">#</a> 代码配置关联限流规则</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 关联模式流控  QPS控制在1以内</span>
<span class="token class-name">String</span> refResource <span class="token operator">=</span> <span class="token string">&quot;test1_ref&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">FlowRule</span> rRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token string">&quot;test1&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// QPS控制在1以内</span>
    <span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_RELATE</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setRefResource</span><span class="token punctuation">(</span>refResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="网页限流规则配置-2"><a href="#网页限流规则配置-2" class="header-anchor">#</a> 网页限流规则配置</h3> <p><a href="https://img-blog.csdnimg.cn/20210115180339225.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20210115180339225.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="测试-2"><a href="#测试-2" class="header-anchor">#</a> 测试</h3> <p>选择QPS，单机阈值为1，选择关联，关联资源为/test_ref，这里用Jmeter模拟高并发，请求/test_ref。</p> <p><a href="https://pics5.baidu.com/feed/a6efce1b9d16fdfa1299f057f44d035296ee7bde.png?token=ced899c66307cdd18da13c06403df487" target="_blank" rel="noopener noreferrer"><img src="https://pics5.baidu.com/feed/a6efce1b9d16fdfa1299f057f44d035296ee7bde.png?token=ced899c66307cdd18da13c06403df487" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>在大批量线程高并发访问/test_ref，导致/test失效了</p> <p><a href="https://pics4.baidu.com/feed/d6ca7bcb0a46f21f736fcc3eb7e6e4660d33ae49.png?token=21c375e0121e5fac15a82a07284c66aa" target="_blank" rel="noopener noreferrer"><img src="https://pics4.baidu.com/feed/d6ca7bcb0a46f21f736fcc3eb7e6e4660d33ae49.png?token=21c375e0121e5fac15a82a07284c66aa" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>链路类型的关联也类似，就不再演示了。多个请求调用同一微服务。</p> <h2 id="warm-up-预热-模式"><a href="#warm-up-预热-模式" class="header-anchor">#</a> Warm up（预热）模式</h2> <p>当流量突然增大的时候，我们常常会希望系统从空闲状态到繁忙状态的切换的时间长一些。即如果系统在此之前长期处于空闲的状态，我们希望处理请求的数量是缓步的增多，经过预期的时间以后，到达系统处理请求个数的最大值。Warm Up（冷启动，预热）模式就是为了实现这个目的的。</p> <p>默认 coldFactor 为 3，即请求 QPS 从 threshold / 3 开始，经预热时长逐渐升至设定的 QPS 阈值。</p> <h3 id="使用注解定义资源"><a href="#使用注解定义资源" class="header-anchor">#</a> 使用注解定义资源</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;testWarmUP&quot;</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;exceptionHandlerOfWarmUp&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testWarmUP&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testWarmUP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;...test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;-------hello baby，i am testWarmUP&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="代码限流规则-2"><a href="#代码限流规则-2" class="header-anchor">#</a> 代码限流规则</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">FlowRule</span> warmUPRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
warmUPRule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">&quot;testWarmUP&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
warmUPRule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
warmUPRule<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
warmUPRule<span class="token punctuation">.</span><span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
warmUPRule<span class="token punctuation">.</span><span class="token function">setControlBehavior</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_WARM_UP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
warmUPRule<span class="token punctuation">.</span><span class="token function">setWarmUpPeriodSec</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="网页限流规则配置-3"><a href="#网页限流规则配置-3" class="header-anchor">#</a> 网页限流规则配置</h3> <p><a href="https://img-blog.csdnimg.cn/20210115201946419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20210115201946419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>先在单机阈值10/3，3的时候，预热10秒后，慢慢将阈值升至20。刚开始刷/testWarmUP，会出现默认错误，预热时间到了后，阈值增加，没超过阈值刷新，请求正常。</p> <p>通常冷启动的过程系统允许通过的 QPS 曲线如下图所示：</p> <p><a href="https://pics7.baidu.com/feed/9922720e0cf3d7ca95ce8b6db1dd310f6b63a93e.png?token=9a8b021a70b874e2d690ef0a1ab04ab0" target="_blank" rel="noopener noreferrer"><img src="https://pics7.baidu.com/feed/9922720e0cf3d7ca95ce8b6db1dd310f6b63a93e.png?token=9a8b021a70b874e2d690ef0a1ab04ab0" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>如秒杀系统在开启瞬间，会有很多流量上来，很可能把系统打死，预热方式就是为了保护系统，可慢慢的把流量放进来，慢慢的把阈值增长到设置的阈值。</p> <h3 id="通过jmeter进行测试"><a href="#通过jmeter进行测试" class="header-anchor">#</a> 通过jmeter进行测试</h3> <h2 id="排队等待模式"><a href="#排队等待模式" class="header-anchor">#</a> 排队等待模式</h2> <p>匀速排队（RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER）方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法。阈值必须设置为QPS。</p> <p><a href="https://pics2.baidu.com/feed/42166d224f4a20a4de73da50d0901724730ed005.png?token=d2a53aac9415b83e46126f0781ae8e4c" target="_blank" rel="noopener noreferrer"><img src="https://pics2.baidu.com/feed/42166d224f4a20a4de73da50d0901724730ed005.png?token=d2a53aac9415b83e46126f0781ae8e4c" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>这种方式主要用于处理间隔性突发的流量，例如消息队列。想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</p> <p>某瞬时来了大流量的请求, 而如果此时要处理所有请求，很可能会导致系统负载过高，影响稳定性。但其实可能后面几秒之内都没有消息投递，若直接把多余的消息丢掉则没有充分利用系统处理消息的能力。Sentinel的Rate Limiter模式能在某一段时间间隔内以匀速方式处理这样的请求, 充分利用系统的处理能力, 也就是削峰填谷, 保证资源的稳定性.</p> <p>Sentinel会以固定的间隔时间让请求通过, 访问资源。当请求到来的时候，如果当前请求距离上个通过的请求通过的时间间隔不小于预设值，则让当前请求通过；否则，计算当前请求的预期通过时间，如果该请求的预期通过时间小于规则预设的 timeout 时间，则该请求会等待直到预设时间到来通过；反之，则马上抛出阻塞异常。</p> <p>使用Sentinel的这种策略, 简单点说, 就是使用一个时间段(比如20s的时间)处理某一瞬时产生的大量请求, 起到一个削峰填谷的作用, 从而充分利用系统的处理能力, 下图能很形象的展示这种场景: X轴代表时间, Y轴代表系统处理的请求.</p> <p><a href="https://img-blog.csdnimg.cn/20190219142010891.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hpb25neGlhbnpl,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20190219142010891.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hpb25neGlhbnpl,size_16,color_FFFFFF,t_70" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h3> <p>模拟2个用户同时并发的访问资源，发出100个请求,</p> <p>如果设置QPS阈值为1, 拒绝策略修改为Rate Limiter匀速RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER方式, 还需要设置setMaxQueueingTimeMs(20 * 1000)表示每一请求最长等待时间, 这里等待时间大一点, 以保证让所有请求都能正常通过;</p> <p>假设这里设置的排队等待时间过小的话, 导致排队等待的请求超时而抛出异常BlockException, 最终结果可能是这100个并发请求中只有一个请求或几个才能正常通过, 所以使用这种模式得根据访问资源的耗时时间决定排队等待时间. 按照目前这种设置, QPS阈值为10的话, 每一个请求相当于是以匀速100ms左右通过.</p> <h3 id="使用注解定义资源-2"><a href="#使用注解定义资源-2" class="header-anchor">#</a> 使用注解定义资源</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;testLineUp&quot;</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;exceptionHandlerOftestLineUp&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testLineUp&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testLineUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;...test1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;-------hello baby，i am testLineUp&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="代码限流规则-3"><a href="#代码限流规则-3" class="header-anchor">#</a> 代码限流规则</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">FlowRule</span> lineUpRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lineUpRule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">&quot;testLineUp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lineUpRule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lineUpRule<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lineUpRule<span class="token punctuation">.</span><span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
lineUpRule<span class="token punctuation">.</span><span class="token function">setMaxQueueingTimeMs</span><span class="token punctuation">(</span><span class="token number">20</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// CONTROL_BEHAVIOR_DEFAULT means requests more than threshold will be rejected immediately.</span>
<span class="token comment">// CONTROL_BEHAVIOR_DEFAULT将超过阈值的流量立即拒绝掉.</span>
lineUpRule<span class="token punctuation">.</span><span class="token function">setControlBehavior</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_RATE_LIMITER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>lineUpRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="网页限流规则配置-4"><a href="#网页限流规则配置-4" class="header-anchor">#</a> 网页限流规则配置</h3> <p><a href="https://img-blog.csdnimg.cn/20210115201054724.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20210115201054724.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="通过jmeter进行测试-2"><a href="#通过jmeter进行测试-2" class="header-anchor">#</a> 通过jmeter进行测试</h3> <p><a href="https://img-blog.csdnimg.cn/20210115201802998.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20210115201802998.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="热点规则-paramflowrule"><a href="#热点规则-paramflowrule" class="header-anchor">#</a> 热点规则 (ParamFlowRule)</h2> <p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p> <ul><li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li> <li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制 热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。</li></ul> <p>热点参数规则（<code>ParamFlowRule</code>）类似于流量控制规则（<code>FlowRule</code>）：</p> <table><thead><tr><th style="text-align:left;">属性</th> <th style="text-align:left;">说明</th> <th style="text-align:left;">默认值</th></tr></thead> <tbody><tr><td style="text-align:left;">resource</td> <td style="text-align:left;">资源名，必填</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">count</td> <td style="text-align:left;">限流阈值，必填</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">grade</td> <td style="text-align:left;">限流模式</td> <td style="text-align:left;">QPS 模式</td></tr> <tr><td style="text-align:left;">durationInSec</td> <td style="text-align:left;">统计窗口时间长度（单位为秒），1.6.0 版本开始支持</td> <td style="text-align:left;">1s</td></tr> <tr><td style="text-align:left;">controlBehavior</td> <td style="text-align:left;">流控效果（支持快速失败和匀速排队模式），1.6.0 版本开始支持</td> <td style="text-align:left;">快速失败</td></tr> <tr><td style="text-align:left;">maxQueueingTimeMs</td> <td style="text-align:left;">最大排队等待时长（仅在匀速排队模式生效），1.6.0 版本开始支持</td> <td style="text-align:left;">0ms</td></tr> <tr><td style="text-align:left;">paramIdx</td> <td style="text-align:left;">热点参数的索引，必填，对应 <code>SphU.entry(xxx, args)</code> 中的参数索引位置</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">paramFlowItemList</td> <td style="text-align:left;">参数例外项，可以针对指定的参数值单独设置限流阈值，不受前面 <code>count</code> 阈值的限制。<strong>仅支持基本类型和字符串类型</strong></td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">clusterMode</td> <td style="text-align:left;">是否是集群参数流控规则</td> <td style="text-align:left;"><code>false</code></td></tr> <tr><td style="text-align:left;">clusterConfig</td> <td style="text-align:left;">集群流控相关配置</td> <td style="text-align:left;"></td></tr></tbody></table> <h3 id="自定义资源"><a href="#自定义资源" class="header-anchor">#</a> 自定义资源</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/byHotKey&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;byHotKey&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;userAccessError&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test4</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">,</span>
                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;goodId&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">int</span> goodId<span class="token punctuation">)</span><span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;...byHotKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;-----------by HotKey： UserId&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="限流规则代码"><a href="#限流规则代码" class="header-anchor">#</a> 限流规则代码：</h3> <p>可以通过 ParamFlowRuleManager 的 loadRules 方法更新热点参数规则，下面是官方实例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ParamFlowRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParamFlowRule</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setParamIdx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 针对 int 类型的参数 PARAM_B，单独设置限流 QPS 阈值为 10，而不是全局的阈值 5.</span>
<span class="token class-name">ParamFlowItem</span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParamFlowItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token constant">PARAM_B</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setClassType</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rule<span class="token punctuation">.</span><span class="token function">setParamFlowItemList</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ParamFlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>具体的限流代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ParamFlowRule</span> pRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParamFlowRule</span><span class="token punctuation">(</span><span class="token string">&quot;byHotKey&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setParamIdx</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 针对 参数值1000，单独设置限流 QPS 阈值为 5，而不是全局的阈值 1.</span>
<span class="token class-name">ParamFlowItem</span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ParamFlowItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setObject</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setClassType</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pRule<span class="token punctuation">.</span><span class="token function">setParamFlowItemList</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ParamFlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>pRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="网页限流规则配置-5"><a href="#网页限流规则配置-5" class="header-anchor">#</a> 网页限流规则配置</h3> <p><a href="https://img-blog.csdnimg.cn/20210116194057665.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20210116194057665.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="_5-sentinel-系统保护"><a href="#_5-sentinel-系统保护" class="header-anchor">#</a> 5. Sentinel 系统保护</h1> <h2 id="系统保护的目的"><a href="#系统保护的目的" class="header-anchor">#</a> 系统保护的目的</h2> <p>在开始之前，我们先了解一下系统保护的目的：</p> <ul><li>保证系统不被拖垮</li> <li>在系统稳定的前提下，保持系统的吞吐量</li></ul> <p>长期以来，系统保护的思路是根据硬指标，即系统的负载 (load1) 来做系统过载保护。当系统负载高于某个阈值，就禁止或者减少流量的进入；当 load 开始好转，则恢复流量的进入。这个思路给我们带来了不可避免的两个问题：</p> <ul><li>load 是一个“结果”，如果根据 load 的情况来调节流量的通过率，那么就始终有延迟性。也就意味着通过率的任何调整，都会过一段时间才能看到效果。当前通过率是使 load 恶化的一个动作，那么也至少要过 1 秒之后才能观测到；同理，如果当前通过率调整是让 load 好转的一个动作，也需要 1 秒之后才能继续调整，这样就浪费了系统的处理能力。所以我们看到的曲线，总是会有抖动。</li> <li>恢复慢。想象一下这样的一个场景（真实），出现了这样一个问题，下游应用不可靠，导致应用 RT 很高，从而 load 到了一个很高的点。过了一段时间之后下游应用恢复了，应用 RT 也相应减少。这个时候，其实应该大幅度增大流量的通过率；但是由于这个时候 load 仍然很高，通过率的恢复仍然不高。</li></ul> <p>系统保护的目标是 <strong>在系统不被拖垮的情况下，提高系统的吞吐率，而不是 load 一定要到低于某个阈值</strong>。如果我们还是按照固有的思维，超过特定的 load 就禁止流量进入，系统 load 恢复就放开流量，这样做的结果是无论我们怎么调参数，调比例，都是按照果来调节因，都无法取得良好的效果。</p> <p>Sentinel 在系统自适应保护的做法是，用 load1 作为启动自适应保护的因子，而允许通过的流量由处理请求的能力，即请求的响应时间以及当前系统正在处理的请求速率来决定。</p> <h3 id="系统保护规则的应用"><a href="#系统保护规则的应用" class="header-anchor">#</a> 系统保护规则的应用</h3> <p>系统规则支持以下的模式：</p> <ul><li><strong>Load 自适应</strong>（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li> <li><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li> <li><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li> <li><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li> <li><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li></ul> <p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p> <p>系统保护规则是应用整体维度的，而不是资源维度的，并且<strong>仅对入口流量生效</strong>。入口流量指的是进入应用的流量（<code>EntryType.IN</code>），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p> <p>系统规则的参数说明:</p> <ul><li>highestSystemLoad 最大的 load1，参考值 -1 (不生效)</li> <li>avgRt 所有入口流量的平均响应时间 -1 (不生效)</li> <li>maxThread 入口流量的最大并发数 -1 (不生效)</li> <li>qps 所有入口资源的 QPS -1 (不生效)</li></ul> <p>硬编码的方式定义流量控制规则如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>entryType <span class="token operator">=</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">,</span> blockHandler <span class="token operator">=</span> <span class="token string">&quot;blockHandlerForHelloWord&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello4&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;Sentinel 你大爷4&quot;</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span></span> srules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SystemRule</span> srule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
srule<span class="token punctuation">.</span><span class="token function">setAvgRt</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
srules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>srule<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SystemRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>srules<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="网页限流规则配置-6"><a href="#网页限流规则配置-6" class="header-anchor">#</a> 网页限流规则配置</h3> <p><a href="https://img-blog.csdnimg.cn/20210116194809712.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20210116194809712.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NyYXp5bWFrZXJjaXJjbGU=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="_6-黑白名单规则"><a href="#_6-黑白名单规则" class="header-anchor">#</a> 6 黑白名单规则</h1> <p>很多时候，我们需要根据调用方来限制资源是否通过，这时候可以使用 Sentinel 的访问控制（黑白名单）的功能。黑白名单根据资源的请求来源（origin）限制资源是否通过，若配置白名单则只有请求来源位于白名单内时才可通过；若配置黑名单则请求来源位于黑名单时不通过，其余的请求通过。</p> <blockquote><p>调用方信息通过 ContextUtil.enter(resourceName, origin) 方法中的 origin 参数传入。</p></blockquote> <h2 id="访问控制规则-authorityrule"><a href="#访问控制规则-authorityrule" class="header-anchor">#</a> 访问控制规则 (AuthorityRule)</h2> <p>授权规则，即黑白名单规则（AuthorityRule）非常简单，主要有以下配置项：</p> <ul><li>resource：资源名，即限流规则的作用对象</li> <li>limitApp：对应的黑名单/白名单，不同 origin 用 , 分隔，如 appA,appB</li> <li>strategy：限制模式，AUTHORITY_WHITE 为白名单模式，AUTHORITY_BLACK 为黑名单模式，默认为白名单模式比如我们希望控制对资源 test 的访问设置白名单，只有来源为 appA 和 appB 的请求才可通过，则可以配置如下白名单规则：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AuthorityRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorityRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rule<span class="token punctuation">.</span><span class="token function">setResource</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rule<span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">AUTHORITY_WHITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rule<span class="token punctuation">.</span><span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token string">&quot;appA,appB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AuthorityRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h1 id="_7-核心组件"><a href="#_7-核心组件" class="header-anchor">#</a> 7 核心组件</h1> <h2 id="resource"><a href="#resource" class="header-anchor">#</a> Resource</h2> <p>resource是sentinel中最重要的一个概念，sentinel通过资源来保护具体的业务代码或其他后方服务。sentinel把复杂的逻辑给屏蔽掉了，用户只需要为受保护的代码或服务定义一个资源，然后定义规则就可以了，剩下的通通交给sentinel来处理了。并且资源和规则是解耦的，规则甚至可以在运行时动态修改。定义完资源后，就可以通过在程序中埋点来保护你自己的服务了，埋点的方式有两种：</p> <ul><li>try-catch 方式（<code>通过 SphU.entry(...)</code>），当 catch 到BlockException时执行异常处理(或fallback)</li> <li>if-else 方式（<code>通过 SphO.entry(...)</code>），当返回 false 时执行异常处理(或fallback)</li></ul> <p>以上这两种方式都是通过硬编码的形式定义资源然后进行资源埋点的，对业务代码的侵入太大，从0.1.1版本开始，sentinel加入了注解的支持，可以通过注解来定义资源，具体的注解为：SentinelResource 。通过注解除了可以定义资源外，还可以指定 blockHandler 和 fallback 方法。</p> <p>在sentinel中具体表示资源的类是：ResourceWrapper ，他是一个抽象的包装类，包装了资源的 Name 和EntryType。他有两个实现类，分别是：StringResourceWrapper 和 MethodResourceWrapper。顾名思义，StringResourceWrapper 是通过对一串字符串进行包装，是一个通用的资源包装类，MethodResourceWrapper 是对方法调用的包装。</p> <h3 id="context"><a href="#context" class="header-anchor">#</a> Context</h3> <p>Context是对资源操作时的上下文环境，每个资源操作(<code>针对Resource进行的entry/exit</code>)必须属于一个Context，如果程序中未指定Context，会创建name为&quot;sentinel_default_context&quot;的默认Context。一个Context生命周期内可能有多个资源操作，Context生命周期内的最后一个资源exit时会清理该Context，这也预示这整个Context生命周期的结束。Context主要属性如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>
    <span class="token comment">// context名字，默认名字 &quot;sentinel_default_context&quot;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token comment">// context入口节点，每个context必须有一个entranceNode</span>
    <span class="token keyword">private</span> <span class="token class-name">DefaultNode</span> entranceNode<span class="token punctuation">;</span>
    <span class="token comment">// context当前entry，Context生命周期中可能有多个Entry，所有curEntry会有变化</span>
    <span class="token keyword">private</span> <span class="token class-name">Entry</span> curEntry<span class="token punctuation">;</span>
    <span class="token comment">// The origin of this context (usually indicate different invokers, e.g. service consumer name or origin IP).</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> origin <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> async<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>注意：一个Context生命期内Context只能初始化一次，因为是存到ThreadLocal中，并且只有在非null时才会进行初始化。</p> <p>如果想在调用 SphU.entry() 或 SphO.entry() 前，自定义一个context，则通过ContextUtil.enter()方法来创建。context是保存在ThreadLocal中的，每次执行的时候会优先到ThreadLocal中获取，为null时会调用 <code>MyContextUtil.myEnter(Constants.CONTEXT_DEFAULT_NAME, &quot;&quot;, resourceWrapper.getType())</code>创建一个context。当Entry执行exit方法时，如果entry的parent节点为null，表示是当前Context中最外层的Entry了，此时将ThreadLocal中的context清空。</p> <h4 id="context的创建与销毁"><a href="#context的创建与销毁" class="header-anchor">#</a> Context的创建与销毁</h4> <p>首先我们要清楚的一点就是，每次执行entry()方法，试图冲破一个资源时，都会生成一个上下文。这个上下文中会保存着调用链的根节点和当前的入口。</p> <p>Context是通过ContextUtil创建的，具体的方法是trueEntry，代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> <span class="token function">trueEnter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 先从ThreadLocal中获取</span>
    <span class="token class-name">Context</span> context <span class="token operator">=</span> contextHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果ThreadLocal中获取不到Context</span>
        <span class="token comment">// 则根据name从map中获取根节点，只要是相同的资源名，就能直接从map中获取到node</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">&gt;</span></span> localCacheNameMap <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">;</span>
        <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> localCacheNameMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 省略部分代码</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token constant">LOCK</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                node <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 省略部分代码</span>
                    <span class="token comment">// 创建一个新的入口节点</span>
                    node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ROOT</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 省略部分代码</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token constant">LOCK</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 创建一个新的Context，并设置Context的根节点，即设置EntranceNode</span>
        context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">setOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将该Context保存到ThreadLocal中去</span>
        contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>上面的代码中我省略了部分代码，只保留了核心的部分。从源码中还是可以比较清晰的看出生成Context的过程：</p> <ul><li>1.先从ThreadLocal中获取，如果能获取到直接返回，如果获取不到则继续第2步</li> <li>2.从一个static的map中根据上下文的名称获取，如果能获取到则直接返回，否则继续第3步</li> <li>3.加锁后进行一次double check，如果还是没能从map中获取到，则创建一个EntranceNode，并把该EntranceNode添加到一个全局的ROOT节点中去，然后将该节点添加到map中去(这部分代码在上述代码中省略了)</li> <li>4.根据EntranceNode创建一个上下文，并将该上下文保存到ThreadLocal中去，下一个请求可以直接获取</li></ul> <p>那保存在ThreadLocal中的上下文什么时候会清除呢？从代码中可以看到具体的清除工作在ContextUtil的exit方法中，当执行该方法时，会将保存在ThreadLocal中的context对象清除，具体的代码非常简单，这里就不贴代码了。</p> <p>那ContextUtil.exit方法什么时候会被调用呢？有两种情况：一是主动调用ContextUtil.exit的时候，二是当一个入口Entry要退出，执行该Entry的trueExit方法的时候，此时会触发ContextUtil.exit的方法。但是有一个前提，就是当前Entry的父Entry为null时，此时说明该Entry已经是最顶层的根节点了，可以清除context。</p> <h3 id="entry"><a href="#entry" class="header-anchor">#</a> Entry</h3> <p>刚才在Context身影中也看到了Entry的出现，现在就谈谈Entry。每次执行 SphU.entry() 或 SphO.entry() 都会返回一个Entry，Entry表示一次资源操作，内部会保存当前invocation信息。在一个Context生命周期中多次资源操作，也就是对应多个Entry，这些Entry形成parent/child结构保存在Entry实例中，entry类CtEntry结构如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">CtEntry</span> <span class="token keyword">extends</span> <span class="token class-name">Entry</span> <span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token class-name">Entry</span> parent <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">Entry</span> child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> chain<span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token class-name">Context</span> context<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> createTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Node</span> curNode<span class="token punctuation">;</span>
    <span class="token comment">/**
* {@link Node} of the specific origin, Usually the origin is the Service Consumer.
*/</span>
    <span class="token keyword">private</span> <span class="token class-name">Node</span> originNode<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Throwable</span> error<span class="token punctuation">;</span> <span class="token comment">// 是否出现异常</span>
    <span class="token keyword">protected</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">;</span> <span class="token comment">// 资源信息</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Entry实例代码中出现了Node，这个又是什么东东呢 😦，咱们接着往下看：</p> <h3 id="defaultnode"><a href="#defaultnode" class="header-anchor">#</a> DefaultNode</h3> <p>Node（<em>关于StatisticNode的讨论放到下一小节</em>）默认实现类DefaultNode，该类还有一个子类EntranceNode；context有一个entranceNode属性，Entry中有一个curNode属性。</p> <ul><li><strong>EntranceNode</strong>：该类的创建是在初始化Context时完成的（ContextUtil.trueEnter方法），注意该类是针对Context维度的，也就是一个context有且仅有一个EntranceNode。</li> <li><strong>DefaultNode</strong>：该类的创建是在NodeSelectorSlot.entry完成的，当不存在context.name对应的DefaultNode时会新建（new DefaultNode(resourceWrapper, null)，对应resouce）并保存到本地缓存（NodeSelectorSlot中private volatile Map&lt;String, DefaultNode&gt; map）；获取到context.name对应的DefaultNode后会将该DefaultNode设置到当前context的curEntry.curNode属性，也就是说，在NodeSelectorSlot中是一个context有且仅有一个DefaultNode。</li></ul> <p>看到这里，你是不是有疑问？为什么一个context有且仅有一个DefaultNode，我们的resouece跑哪去了呢，其实，这里的一个context有且仅有一个DefaultNode是在NodeSelectorSlot范围内，NodeSelectorSlot是ProcessorSlotChain中的一环，获取ProcessorSlotChain是根据Resource维度来的。总结为一句话就是：<strong>针对同一个Resource，多个context对应多个DefaultNode；针对不同Resource，(不管是否是同一个context)对应多个不同DefaultNode</strong>。这还没看明白 : (，好吧，我不bb了，上图吧：</p> <p>public class DefaultNode extends StatisticNode {
private ResourceWrapper id;
/**
* The list of all child nodes.
* 子节点集合
<em>/
private volatile Set childList = new HashSet&lt;&gt;();
/</em>*
* Associated cluster node.
*/
private ClusterNode clusterNode;
}</p> <p>一个Resouce只有一个clusterNode，多个defaultNode对应一个clusterNode，如果defaultNode.clusterNode为null，则在ClusterBuilderSlot.entry中会进行初始化。</p> <p>同一个Resource，对应同一个ProcessorSlotChain，这块处理逻辑在lookProcessChain方法中，如下：</p> <p>ProcessorSlot lookProcessChain(ResourceWrapper resourceWrapper) {
ProcessorSlotChain chain = chainMap.get(resourceWrapper);
if (chain == null) {
synchronized (LOCK) {
chain = chainMap.get(resourceWrapper);
if (chain == null) {
// Entry size limit.
if (chainMap.size() &gt;= Constants.MAX_SLOT_CHAIN_SIZE) {
return null;
}<code>chain = SlotChainProvider.newSlotChain(); Map&lt;ResourceWrapper, ProcessorSlotChain&gt; newMap = newHashMap&lt;ResourceWrapper, ProcessorSlotChain&gt;( chainMap.size() + 1); newMap.putAll(chainMap); newMap.put(resourceWrapper, chain); chainMap = newMap; } }</code>}
return chain;
}StatisticNode<code>StatisticNode中保存了资源的实时统计数据（基于滑动时间窗口机制），通过这些统计数据，sentinel才能进行限流、降级等一系列操作。StatisticNode属性如下： public class StatisticNode implements Node { /** * 秒级的滑动时间窗口（时间窗口单位500ms） */ private transient volatile Metric rollingCounterInSecond = newArrayMetric(SampleCountProperty.SAMPLE_COUNT, IntervalProperty.INTERVAL); /** * 分钟级的滑动时间窗口（时间窗口单位1s） */ private transient Metric rollingCounterInMinute = new ArrayMetric(60, 60 * 1000,false); /** * The counter for thread count. 线程个数用户触发线程数流控 */ private LongAdder curThreadNum = new LongAdder(); } public class ArrayMetric implements Metric { private final LeapArray&lt;MetricBucket&gt; data; } public class MetricBucket { // 保存统计值 private final LongAdder[] counters; // 最小rt private volatile long minRt; }</code>其中MetricBucket.counters数组大小为MetricEvent枚举值的个数，每个枚举对应一个统计项，比如PASS表示通过个数，限流可根据通过的个数和设置的限流规则配置count大小比较，得出是否触发限流操作，所有枚举值如下：<code>public enum MetricEvent { PASS, // Normal pass. BLOCK, // Normal block. EXCEPTION, SUCCESS, RT, OCCUPIED_PASS }</code>8 插槽Slotslot是另一个sentinel中非常重要的概念，sentinel的工作流程就是围绕着一个个插槽所组成的插槽链来展开的。需要注意的是每个插槽都有自己的职责，他们各司其职完好的配合，通过一定的编排顺序，来达到最终的限流降级的目的。默认的各个插槽之间的顺序是固定的，因为有的插槽需要依赖其他的插槽计算出来的结果才能进行工作。但是这并不意味着我们只能按照框架的定义来，sentinel 通过 SlotChainBuilder 作为 SPI 接口，使得 Slot Chain 具备了扩展的能力。我们可以通过实现 SlotsChainBuilder 接口加入自定义的 slot 并自定义编排各个 slot 之间的顺序，从而可以给 sentinel 添加自定义的功能。那SlotChain是在哪创建的呢？是在 CtSph.lookProcessChain() 方法中创建的，并且该方法会根据当前请求的资源先去一个静态的HashMap中获取，如果获取不到才会创建，创建后会保存到HashMap中。这就意味着，同一个资源会全局共享一个SlotChain。默认生成ProcessorSlotChain为：<code>// DefaultSlotChainBuilder public ProcessorSlotChain build() { ProcessorSlotChain chain = new DefaultProcessorSlotChain(); chain.addLast(new NodeSelectorSlot()); chain.addLast(new ClusterBuilderSlot()); chain.addLast(new LogSlot()); chain.addLast(new StatisticSlot()); chain.addLast(new SystemSlot()); chain.addLast(new AuthoritySlot()); chain.addLast(new FlowSlot()); chain.addLast(new DegradeSlot()); return chain;</code>这里大概的介绍下每种Slot的功能职责：<code>NodeSelectorSlot</code> 负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级；<code>ClusterBuilderSlot</code> 则用于存储资源的统计信息以及调用者信息，例如该资源的 RT, QPS, thread count 等等，这些信息将用作为多维度限流，降级的依据；<code>StatisticsSlot</code> 则用于记录，统计不同维度的 runtime 信息；<code>SystemSlot</code> 则通过系统的状态，例如 load1 等，来控制总的入口流量；<code>AuthoritySlot</code> 则根据黑白名单，来做黑白名单控制；<code>FlowSlot</code> 则用于根据预设的限流规则，以及前面 slot 统计的状态，来进行限流；<code>DegradeSlot</code> 则通过统计信息，以及预设的规则，来做熔断降级；每个Slot执行完业务逻辑处理后，会调用fireEntry()方法，该方法将会触发下一个节点的entry方法，下一个节点又会调用他的fireEntry，以此类推直到最后一个Slot，由此就形成了sentinel的责任链。下面我们就来详细研究下这些Slot的原理。NodeSelectorSlot<code>NodeSelectorSlot</code> 是用来构造调用链的，具体的是将资源的调用路径，封装成一个一个的节点，再组成一个树状的结构来形成一个完整的调用链，<code>NodeSelectorSlot</code>是所有Slot中最关键也是最复杂的一个Slot，这里涉及到以下几个核心的概念：Resource资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它服务，甚至可以是一段代码。只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。简单来说，资源就是 Sentinel 用来保护系统的一个媒介。源码中用来包装资源的类是：<code>com.alibaba.csp.sentinel.slotchain.ResourceWrapper</code>，他有两个子类：<code>StringResourceWrapper</code> 和 <code>MethodResourceWrapper</code>，通过名字就知道可以将一段字符串或一个方法包装为一个资源。打个比方，我有一个服务A，请求非常多，经常会被陡增的流量冲垮，为了防止这种情况，简单的做法，我们可以定义一个 Sentinel 的资源，通过该资源来对请求进行调整，使得允许通过的请求不会把服务A搞崩溃。<a href="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzMzZTY5MjUzMTgzNGFmYjFkYWNmMTRmYTYyNTAyNzFmLmpwZw?x-oss-process=image/format,png" target="_blank" rel="noopener noreferrer"><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzMzZTY5MjUzMTgzNGFmYjFkYWNmMTRmYTYyNTAyNzFmLmpwZw?x-oss-process=image/format,png" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>每个资源的状态也是不同的，这取决于资源后端的服务，有的资源可能比较稳定，有的资源可能不太稳定。那么在整个调用链中，Sentinel 需要对不稳定资源进行控制。当调用链路中某个资源出现不稳定，例如，表现为 timeout，或者异常比例升高的时候，则对这个资源的调用进行限制，并让请求快速失败，避免影响到其它的资源，最终导致雪崩的后果。Context上下文是一个用来保存调用链当前状态的元数据的类，每次进入一个资源时，就会创建一个上下文。**相同的资源名可能会创建多个上下文。**一个Context中包含了三个核心的对象：1）当前调用链的根节点：EntranceNode2）当前的入口：Entry3）当前入口所关联的节点：Node上下文中只会保存一个当前正在处理的入口Entry，另外还会保存调用链的根节点。**需要注意的是，每次进入一个新的资源时，都会创建一个新的上下文。**Entry每次调用 <code>SphU#entry()</code> 都会生成一个Entry入口，该入口中会保存了以下数据：入口的创建时间，当前入口所关联的节点，当前入口所关联的调用源对应的节点。Entry是一个抽象类，他只有一个实现类，在CtSph中的一个静态类：CtEntryNode节点是用来保存某个资源的各种实时统计信息的，他是一个接口，通过访问节点，就可以获取到对应资源的实时状态，以此为依据进行限流和降级操作。可能看到这里，大家还是比较懵，这么多类到底有什么用，接下来就让我们更进一步，挖掘一下这些类的作用，在这之前，我先给大家展示一下他们之间的关系，如下图所示：<a href="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2ZlNTVhOTFmYTI1NzNhZmU0ZDRiOTM2ZTRiMmQyYjEyLmpwZw?x-oss-process=image/format,png" target="_blank" rel="noopener noreferrer"><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2ZlNTVhOTFmYTI1NzNhZmU0ZDRiOTM2ZTRiMmQyYjEyLmpwZw?x-oss-process=image/format,png" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这里把几种Node的作用先大概介绍下：节点作用StatisticNode执行具体的资源统计操作DefaultNode该节点持有指定上下文中指定资源的统计信息，当在同一个上下文中多次调用entry方法时，该节点可能下会创建有一系列的子节点。 另外每个DefaultNode中会关联一个ClusterNodeClusterNode该节点中保存了资源的总体的运行时统计信息，包括rt，线程数，qps等等，相同的资源会全局共享同一个ClusterNode，不管他属于哪个上下文EntranceNode该节点表示一棵调用链树的入口节点，通过他可以获取调用链树中所有的子节点调用链树当在一个上下文中多次调用了 SphU#entry() 方法时，就会创建一棵调用链树。具体的代码在entry方法中创建CtEntry对象时：<code>CtEntry(ResourceWrapper resourceWrapper, ProcessorSlot&lt;Object&gt; chain, Context context) { super(resourceWrapper); this.chain = chain; this.context = context; // 获取「上下文」中上一次的入口 parent = context.getCurEntry(); if (parent != null) { // 然后将当前入口设置为上一次入口的子节点 ((CtEntry)parent).child = this; } // 设置「上下文」的当前入口为该类本身 context.setCurEntry(this); }</code>这里可能看代码没有那么直观，可以用一些图形来描述一下这个过程。</p> <h3 id="构造树干"><a href="#构造树干" class="header-anchor">#</a> 构造树干</h3> <p>创建contextcontext的创建在上面已经分析过了，初始化的时候，context中的curEntry属性是没有值的，如下图所示：<a href="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzllZjlmNThlNjkzMjE3ZTc1Y2JjMjEzNjM3ZTc2Y2E5LmpwZw?x-oss-process=image/format,png" target="_blank" rel="noopener noreferrer"><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzllZjlmNThlNjkzMjE3ZTc1Y2JjMjEzNjM3ZTc2Y2E5LmpwZw?x-oss-process=image/format,png" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>创建Entry每创建一个新的Entry对象时，都会重新设置context的curEntry，并将context原来的curEntry设置为该新Entry对象的父节点，如下图所示：<a href="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2UyMTMzNjYwZTc5OGVkMTU5MTY5YmFmMDM4N2I4NzA1LmpwZw?x-oss-process=image/format,png" target="_blank" rel="noopener noreferrer"><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2UyMTMzNjYwZTc5OGVkMTU5MTY5YmFmMDM4N2I4NzA1LmpwZw?x-oss-process=image/format,png" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>退出Entry某个Entry退出时，将会重新设置context的curEntry，当该Entry是最顶层的一个入口时，将会把ThreadLocal中保存的context也清除掉，如下图所示：<a href="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzlkYzQzNjY1MjliMTIwN2Y2NjA4OGExMDE2NGU0Y2ZlLmpwZw?x-oss-process=image/format,png" target="_blank" rel="noopener noreferrer"><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzlkYzQzNjY1MjliMTIwN2Y2NjA4OGExMDE2NGU0Y2ZlLmpwZw?x-oss-process=image/format,png" alt="img"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>构造叶子节点上面的过程是构造了一棵调用链的树，但是这棵树只有树干，没有叶子，那叶子节点是在什么时候创建的呢？DefaultNode就是叶子节点，在叶子节点中保存着目标资源在当前状态下的统计信息。通过分析，我们知道了叶子节点是在NodeSelectorSlot的entry方法中创建的。具体的代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据「上下文」的名称获取DefaultNode</span>
    <span class="token comment">// 多线程环境下，每个线程都会创建一个context，</span>
    <span class="token comment">// 只要资源名相同，则context的名称也相同，那么获取到的节点就相同</span>
    <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果当前「上下文」中没有该节点，则创建一个DefaultNode节点</span>
                node <span class="token operator">=</span> <span class="token class-name">Env</span><span class="token punctuation">.</span>nodeBuilder<span class="token punctuation">.</span><span class="token function">buildTreeNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 省略部分代码</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 将当前node作为「上下文」的最后一个节点的子节点添加进去</span>
            <span class="token comment">// 如果context的curEntry.parent.curNode为null，则添加到entranceNode中去</span>
            <span class="token comment">// 否则添加到context的curEntry.parent.curNode中去</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultNode</span><span class="token punctuation">)</span>context<span class="token punctuation">.</span><span class="token function">getLastNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将该节点设置为「上下文」中的当前节点</span>
    <span class="token comment">// 实际是将当前节点赋值给context中curEntry的curNode</span>
    <span class="token comment">// 在Context的getLastNode中会用到在此处设置的curNode</span>
    context<span class="token punctuation">.</span><span class="token function">setCurNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><code>上面的代码可以分解成下面这些步骤： 1）获取当前上下文对应的DefaultNode，如果没有的话会为当前的调用新生成一个DefaultNode节点，它的作用是对资源进行各种统计度量以便进行流控； 2）将新创建的DefaultNode节点，添加到context中，作为「entranceNode」或者「curEntry.parent.curNode」的子节点； 3）将DefaultNode节点，添加到context中，作为「curEntry」的curNode。上面的第2步，不是每次都会执行。我们先看第3步，把当前DefaultNode设置为context的curNode，实际上是把当前节点赋值给context中curEntry的curNode，用图形表示就是这样：[![img](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2ZmYjgwODNlYWY1MDZlOTQ0ZGYxNjI3ZTdjZjg5NTEzLmpwZw?x-oss-process=image/format,png)](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2ZmYjgwODNlYWY1MDZlOTQ0ZGYxNjI3ZTdjZjg5NTEzLmpwZw?x-oss-process=image/format,png)多次创建不同的Entry，并且执行NodeSelectorSlot的entry方法后，就会变成这样一棵调用链树：[![img](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2Y1YmM5YjRmNTgzZDYzZGM0ZGU1ZThiYWU0MWU4YzIwLmpwZw?x-oss-process=image/format,png)](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2Y1YmM5YjRmNTgzZDYzZGM0ZGU1ZThiYWU0MWU4YzIwLmpwZw?x-oss-process=image/format,png)**PS：这里图中的node0，node1，node2可能是相同的node，因为在同一个context中从map中获取的node是同一个，这里只是为了表述的更清楚所以用了不同的节点名。**保存子节点上面已经分析了叶子节点的构造过程，叶子节点是保存在各个Entry的curNode属性中的。我们知道context中只保存了入口节点和当前Entry，那子节点是什么时候保存的呢，其实子节点就是上面代码中的第2步中保存的。下面我们来分析上面的第2步的情况：第一次调用NodeSelectorSlot的entry方法时，map中肯定是没有DefaultNode的，那就会进入第2步中，创建一个node，创建完成后会把该节点加入到context的lastNode的子节点中去。我们先看一下context的getLastNode方法：</code>public Node getLastNode() {    // 如果curEntry不存在时，返回entranceNode    // 否则返回curEntry的lastNode，    // 需要注意的是curEntry的lastNode是获取的parent的curNode，    // 如果每次进入的资源不同，就会每次都创建一个CtEntry，则parent为null，    // 所以curEntry.getLastNode()也为null    if (curEntry != null &amp;&amp; curEntry.getLastNode() != null) {        return curEntry.getLastNode();    } else {        return entranceNode;    } } <code>代码中我们可以知道，lastNode的值可能是context中的entranceNode也可能是curEntry.parent.curNode，但是他们都是「DefaultNode」类型的节点，DefaultNode的所有子节点是保存在一个HashSet中的。第一次调用getLastNode方法时，context中curEntry是null，因为curEntry是在第3步中才赋值的。所以，lastNode最初的值就是context的entranceNode。那么将node添加到entranceNode的子节点中去之后就变成了下面这样：[![img](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzU3NWIyN2NkODE2NzEzOGY1NmFlODI4MDhkYWM3OTkwLmpwZw?x-oss-process=image/format,png)](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzU3NWIyN2NkODE2NzEzOGY1NmFlODI4MDhkYWM3OTkwLmpwZw?x-oss-process=image/format,png)紧接着再进入一次，资源名不同，会再次生成一个新的Entry，上面的图形就变成下图这样：[![img](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzRjNDRmMmJkMGIyY2M1MjIzODY4Zjc1ZTI4ZDk4OTFhLmpwZw?x-oss-process=image/format,png)](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzRjNDRmMmJkMGIyY2M1MjIzODY4Zjc1ZTI4ZDk4OTFhLmpwZw?x-oss-process=image/format,png)此时再次调用context的getLastNode方法，因为此时curEntry的parent不再是null了，所以获取到的lastNode是curEntry.parent.curNode，在上图中可以很方便的看出，这个节点就是**node0**。那么把当前节点node1添加到lastNode的子节点中去，上面的图形就变成下图这样：[![img](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzE1YzExYzM0NjhhMjExYjYwODNlYTRlNmI5MjJjMDQ1LmpwZw?x-oss-process=image/format,png)](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuLzE1YzExYzM0NjhhMjExYjYwODNlYTRlNmI5MjJjMDQ1LmpwZw?x-oss-process=image/format,png)然后将当前node设置给context的curNode，上面的图形就变成下图这样：[![img](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2YwYTMxNWM5MmRlZDhlNzMxYTI0NTZiZjg1MTc0MjIzLmpwZw?x-oss-process=image/format,png)](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2YwYTMxNWM5MmRlZDhlNzMxYTI0NTZiZjg1MTc0MjIzLmpwZw?x-oss-process=image/format,png)假如再创建一个Entry，然后再进入一次不同的资源名，上面的图就变成下面这样：[![img](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2U0NjE4YmJiNzgwMzc3NGM4ZDFmODYyMjkwOGVmNmQ1LmpwZw?x-oss-process=image/format,png)](https://imgconvert.csdnimg.cn/aHR0cDovL3N0YXRpYy5pb2NvZGVyLmNuL2U0NjE4YmJiNzgwMzc3NGM4ZDFmODYyMjkwOGVmNmQ1LmpwZw?x-oss-process=image/format,png)至此NodeSelectorSlot的基本功能已经大致分析清楚了。**PS：以上的分析是基于每次执行SphU.entry(name)时，资源名都是不一样的前提下。如果资源名都一样的话，那么生成的node都相同，则只会再第一次把node加入到entranceNode的子节点中去，其他的时候，只会创建一个新的Entry，然后替换context中的curEntry的值。**ClusterBuilderSlotNodeSelectorSlot的entry方法执行完之后，会调用fireEntry方法，此时会触发ClusterBuilderSlot的entry方法。ClusterBuilderSlot的entry方法比较简单，具体代码如下：</code>@Override public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, Object... args) throws Throwable {    if (clusterNode == null) {        synchronized (lock) {            if (clusterNode == null) {                // Create the cluster node.                clusterNode = Env.nodeBuilder.buildClusterNode();                // 将clusterNode保存到全局的map中去                HashMap&lt;ResourceWrapper, ClusterNode&gt; newMap = new HashMap&lt;ResourceWrapper, ClusterNode&gt;(16);                newMap.putAll(clusterNodeMap);                newMap.put(node.getId(), clusterNode);                 clusterNodeMap = newMap;            }        }    }    // 将clusterNode塞到DefaultNode中去    node.setClusterNode(clusterNode);     // 省略部分代码     fireEntry(context, resourceWrapper, node, count, args); } <code>NodeSelectorSlot的职责比较简单，主要做了两件事：一、为每个资源创建一个clusterNode，然后把clusterNode塞到DefaultNode中去二、将clusterNode保持到全局的map中去，用资源作为map的key**PS：一个资源只有一个ClusterNode，但是可以有多个DefaultNode**StatistcSlotStatisticSlot负责来统计资源的实时状态，具体的代码如下：</code>@Override public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, Object... args) throws Throwable {    try {        // 触发下一个Slot的entry方法        fireEntry(context, resourceWrapper, node, count, args);        // 如果能通过SlotChain中后面的Slot的entry方法，说明没有被限流或降级        // 统计信息        node.increaseThreadNum();        node.addPassRequest();        // 省略部分代码    } catch (BlockException e) {        context.getCurEntry().setError(e);        // Add block count.        node.increaseBlockedQps();        // 省略部分代码        throw e;    } catch (Throwable e) {        context.getCurEntry().setError(e);        // Should not happen        node.increaseExceptionQps();        // 省略部分代码        throw e;    } } @Override public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {    DefaultNode node = (DefaultNode)context.getCurNode();    if (context.getCurEntry().getError() == null) {        long rt = TimeUtil.currentTimeMillis() - context.getCurEntry().getCreateTime();        if (rt &gt; Constants.TIME_DROP_VALVE) {            rt = Constants.TIME_DROP_VALVE;        }        node.rt(rt);        // 省略部分代码        node.decreaseThreadNum();        // 省略部分代码    }     fireExit(context, resourceWrapper, count); } <code>代码分成了两部分，第一部分是entry方法，该方法首先会触发后续slot的entry方法，即SystemSlot、FlowSlot、DegradeSlot等的规则，如果规则不通过，就会抛出BlockException，则会在node中统计被block的数量。反之会在node中统计通过的请求数和线程数等信息。第二部分是在exit方法中，当退出该Entry入口时，会统计rt的时间，并减少线程数。这些统计的实时数据会被后续的校验规则所使用，具体的统计方式是通过</code>滑动窗口<code>来实现的。SystemSlotSystemSlot就是根据总的请求统计信息，来做流控，主要是防止系统被搞垮，具体的代码如下：</code>@Override public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count,                  boolean prioritized, Object... args) throws Throwable {    SystemRuleManager.checkSystem(resourceWrapper);    fireEntry(context, resourceWrapper, node, count, prioritized, args); } ``public static void checkSystem(ResourceWrapper resourceWrapper) throws BlockException {    if (resourceWrapper == null) {        return;    }    // Ensure the checking switch is on.    if (!checkSystemStatus.get()) {        return;    }     // for inbound traffic only    if (resourceWrapper.getEntryType() != EntryType.IN) {        return;    }     // total qps    double currentQps = Constants.ENTRY_NODE == null ? 0.0 : Constants.ENTRY_NODE.successQps();    if (currentQps &gt; qps) {        throw new SystemBlockException(resourceWrapper.getName(), &quot;qps&quot;);    }     // total thread    int currentThread = Constants.ENTRY_NODE == null ? 0 : Constants.ENTRY_NODE.curThreadNum();    if (currentThread &gt; maxThread) {        throw new SystemBlockException(resourceWrapper.getName(), &quot;thread&quot;);    }     double rt = Constants.ENTRY_NODE == null ? 0 : Constants.ENTRY_NODE.avgRt();    if (rt &gt; maxRt) {        throw new SystemBlockException(resourceWrapper.getName(), &quot;rt&quot;);    }     // BBR算法    // load. BBR algorithm.    if (highestSystemLoadIsSet &amp;&amp; getCurrentSystemAvgLoad() &gt; highestSystemLoad) {        if (!checkBbr(currentThread)) {            throw new SystemBlockException(resourceWrapper.getName(), &quot;load&quot;);        }    }     // cpu usage    if (highestCpuUsageIsSet &amp;&amp; getCurrentCpuUsage() &gt; highestCpuUsage) {        throw new SystemBlockException(resourceWrapper.getName(), &quot;cpu&quot;);    } } <code>其中的Constants.ENTRY_NODE是一个全局的ClusterNode，该节点的值是在StatisticsSlot中进行统计的。当前的统计值和系统配置的进行比较，各个维度超过范围抛BlockExceptionAuthoritySlotAuthoritySlot做的事也比较简单，主要是根据黑白名单进行过滤，只要有一条规则校验不通过，就抛出异常。</code>@Override public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count, boolean prioritized, Object... args)    throws Throwable {    checkBlackWhiteAuthority(resourceWrapper, context);    fireEntry(context, resourceWrapper, node, count, prioritized, args); } void checkBlackWhiteAuthority(ResourceWrapper resource, Context context) throws AuthorityException {    // 通过监听来的规则集    Map&lt;String, Set<AuthorityRule>&gt; authorityRules = AuthorityRuleManager.getAuthorityRules();     if (authorityRules == null) {        return;    }     // 根据资源名称获取相应的规则    Set<AuthorityRule> rules = authorityRules.get(resource.getName());    if (rules == null) {        return;    }     for (AuthorityRule rule : rules) {        // 黑名单白名单验证        // 只要有一条规则校验不通过，就抛出AuthorityException        if (!AuthorityRuleChecker.passCheck(rule, context)) {            throw new AuthorityException(context.getOrigin(), rule);        }    } } <code>FlowSlotFlowSlot主要是根据前面统计好的信息，与设置的限流规则进行匹配校验，如果规则校验不通过则进行限流，具体的代码如下：</code>@Override public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count,                  boolean prioritized, Object... args) throws Throwable {    checkFlow(resourceWrapper, context, node, count, prioritized);     fireEntry(context, resourceWrapper, node, count, prioritized, args); } void checkFlow(ResourceWrapper resource, Context context, DefaultNode node, int count, boolean prioritized)    throws BlockException {    checker.checkFlow(ruleProvider, resource, context, node, count, prioritized); } <code>DegradeSlotDegradeSlot主要是根据前面统计好的信息，与设置的降级规则进行匹配校验，如果规则校验不通过则进行降级，具体的代码如下：</code>@Override public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count,                  boolean prioritized, Object... args) throws Throwable {    performChecking(context, resourceWrapper);     fireEntry(context, resourceWrapper, node, count, prioritized, args); } void performChecking(Context context, ResourceWrapper r) throws BlockException {    List<CircuitBreaker> circuitBreakers = 		        DegradeRuleManager.getCircuitBreakers(r.getName());        if (circuitBreakers == null || circuitBreakers.isEmpty()) {        return;    }    for (CircuitBreaker cb : circuitBreakers) {        if (!cb.tryPass(context)) {            throw new DegradeException(cb.getRule().getLimitApp(), cb.getRule());        }    } } <code>DefaultProcessorSlotChainChain 是链条的意思，从build的方法可看出，ProcessorSlotChain 是一个链表，里面添加了很多个 Slot。都是 ProcessorSlot 的子类。具体的实现需要到 DefaultProcessorSlotChain 中去看。</code>public class DefaultProcessorSlotChain extends ProcessorSlotChain {     AbstractLinkedProcessorSlot&lt;?&gt; first = new AbstractLinkedProcessorSlot<Object>() {         @Override        public void entry(Context context, ResourceWrapper resourceWrapper, Object t, int count, boolean prioritized, Object... args)            throws Throwable {            super.fireEntry(context, resourceWrapper, t, count, prioritized, args);        }         @Override        public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {            super.fireExit(context, resourceWrapper, count, args);        }     };    AbstractLinkedProcessorSlot&lt;?&gt; end = first;     @Override    public void addFirst(AbstractLinkedProcessorSlot&lt;?&gt; protocolProcessor) {        protocolProcessor.setNext(first.getNext());        first.setNext(protocolProcessor);        if (end == first) {            end = protocolProcessor;        }    }     @Override    public void addLast(AbstractLinkedProcessorSlot&lt;?&gt; protocolProcessor) {        end.setNext(protocolProcessor);        end = protocolProcessor;    }     /**     * Same as {@link #addLast(AbstractLinkedProcessorSlot)}.     *     * @param next processor to be added.     <em>/    @Override    public void setNext(AbstractLinkedProcessorSlot&lt;?&gt; next) {        addLast(next);    }     @Override    public AbstractLinkedProcessorSlot&lt;?&gt; getNext() {        return first.getNext();    }     @Override    public void entry(Context context, ResourceWrapper resourceWrapper, Object t, int count, boolean prioritized, Object... args)        throws Throwable {        first.transformEntry(context, resourceWrapper, t, count, prioritized, args);    }     @Override    public void exit(Context context, ResourceWrapper resourceWrapper, int count, Object... args) {        first.exit(context, resourceWrapper, count, args);    } } <code>DefaultProcessorSlotChain中有两个AbstractLinkedProcessorSlot类型的变量：first和end，这就是链表的头结点和尾节点。创建DefaultProcessorSlotChain对象时，首先创建了首节点，然后把首节点赋值给了尾节点，可以用下图表示： [![在这里插入图片描述](https://img-blog.csdnimg.cn/20200610170547287.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h4eWFzY3g=,size_16,color_FFFFFF,t_70)](https://img-blog.csdnimg.cn/20200610170547287.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h4eWFzY3g=,size_16,color_FFFFFF,t_70) 将第一个节点添加到链表中后，整个链表的结构变成了如下图这样：[![在这里插入图片描述](https://img-blog.csdnimg.cn/20200525165953933.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h4eWFzY3g=,size_16,color_FFFFFF,t_70)](https://img-blog.csdnimg.cn/20200525165953933.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h4eWFzY3g=,size_16,color_FFFFFF,t_70) 将所有的节点都加入到链表中后，整个链表的结构变成了如下图所示：[![在这里插入图片描述](https://img-blog.csdnimg.cn/20200525170026637.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h4eWFzY3g=,size_16,color_FFFFFF,t_70)](https://img-blog.csdnimg.cn/20200525170026637.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h4eWFzY3g=,size_16,color_FFFFFF,t_70) 这样就将所有的Slot对象添加到了链表中去了，每一个Slot都是继承自AbstractLinkedProcessorSlot。而AbstractLinkedProcessorSlot是一种责任链的设计，每个对象中都有一个next属性，指向的是另一个AbstractLinkedProcessorSlot对象。其实责任链模式在很多框架中都有，比如Netty中是通过pipeline来实现的。知道了SlotChain是如何创建的了，那接下来就要看下是如何执行Slot的entry方法的了从这里可以看到，从fireEntry方法中就开始传递执行entry了，这里会执行当前节点的下一个节点transformEntry方法，上面已经分析过了，transformEntry方法会触发当前节点的entry，也就是说fireEntry方法实际是触发了下一个节点的entry方法。 [![在这里插入图片描述](https://img-blog.csdnimg.cn/20200525170301722.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h4eWFzY3g=,size_16,color_FFFFFF,t_70)](https://img-blog.csdnimg.cn/20200525170301722.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h4eWFzY3g=,size_16,color_FFFFFF,t_70)从最初的调用Chain的entry()方法，转变成了调用SlotChain中Slot的entry()方法。从</code>@SpiOrder(-10000)<code>知道，SlotChain中的第一个Slot节点是NodeSelectorSlot。slot总结sentinel的限流降级等功能，主要是通过一个SlotChain实现的。在链式插槽中，有7个核心的Slot，这些Slot各司其职，可以分为以下几种类型：一、进行资源调用路径构造的NodeSelectorSlot和ClusterBuilderSlot二、进行资源的实时状态统计的StatisticsSlot三、进行系统保护，限流，降级等规则校验的SystemSlot、AuthoritySlot、FlowSlot、DegradeSlot后面几个Slot依赖于前面几个Slot统计的结果。至此，每种Slot的功能已经基本分析清楚了。9 .sentinel滑动窗口实现原理基本原理滑动窗口可以先拆为滑动跟窗口两个词，先介绍下</code>窗口<code>，你可以这么理解，一段是时间就是窗口，比如说我们可以把这个1s认为是1个</code>窗口<code>这个样子我们就能将1分钟就可以划分成60个</code>窗口<code>了，这个没毛病吧。如下图我们就分成了60个</code>窗口<code>（这个多了我们就画5个表示一下） [![在这里插入图片描述](https://img-blog.csdnimg.cn/20201227233202648.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_1,color_FFFFFF,t_70)](https://img-blog.csdnimg.cn/20201227233202648.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_1,color_FFFFFF,t_70) 比如现在处于第1秒上，那1s那个窗口就是</code>当前窗口<code>，就如下图中红框表示。 [![在这里插入图片描述](https://img-blog.csdnimg.cn/20201227233403528.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70)](https://img-blog.csdnimg.cn/20201227233403528.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70) 好了，窗口就介绍完了，现在在来看下</code>滑动<code>，滑动很简单，比如说现在时间由第1秒变成了第2秒，就是从当前这个窗口----&gt;下一个窗口就可以了，这个时候下一个窗口就变成了当前窗口，之前那个当前窗口就变成了上一个窗口，这个过程其实就是滑动。 [![在这里插入图片描述](https://img-blog.csdnimg.cn/20201227233659906.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70)](https://img-blog.csdnimg.cn/20201227233659906.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70)好了，介绍完了滑动窗口，我们再来介绍下这个sentinel的滑动窗口的实现原理。 其实你要是理解了上面这个滑动窗口的意思，sentinel实现原理就简单了。 先是介绍下窗口中里面都存储些啥。也就是上面这个小框框都有啥。它得有个开始时间吧，不然你怎么知道这个窗口是什么时候开始的还得有个窗口的长度吧，不然你咋知道窗口啥时候结束，通过这个开始时间+窗口长度=窗口结束时间，就比如说上面的1s，间隔1s最后就是要在这个窗口里面统计的东西，你总不能白搞些窗口，搞些滑动吧。所以这里就存储了一堆要统计的指标（qps，rt等等）说完了这一个小窗口里面的东西，就得来说说是怎么划分这个小窗口，怎么管理这些小窗口的了，也就是我们的视野得往上提高一下了，不能总聚在这个小窗口上。要知道有多少个小窗口，在sentinel中也就是sampleCount，比如说我们有60个窗口。还有就是intervalInMs，这个intervalInMs是用来计算这个窗口长度的，intervalInMs/窗口数量= 窗口长度。也就是我给你1分钟，你给我分成60个窗口，这个时候窗口长度就是1s了，那如果我给你1s，你给我分2个窗口，这个时候窗口长度就是500毫秒了，这个1分钟，就是intervalInMs。再就是存储这个窗口的容器（这里是数组），毕竟那么多窗口，还得提供计算当前时间窗口的方法等等最后我们就来看看这个当前时间窗口是怎么计算的。 咱们就拿 60个窗口，这个60个窗口放在数组中，窗口长度是1s 来计算，看看当前时间戳的一个时间窗口是是在数组中哪个位置。比如说当前时间戳是1609085401454 ms，算出秒 = 1609085401454 /1000（窗口长度）</code>在数组的位置 = 算出秒 %数组长度 <code>我们再来计算下 某个时间戳对应窗口的起始时间，还是以1609085401454 来计算</code>窗口startTime = 1609085401454 - 1609085401454%1000（窗口长度）=454 <code>这里1609085401454%1000（窗口长度） 能算出来它的毫秒值，也就是454 ， 减去这个后就变成了1609085401000好了，sentinel 滑动窗口原理就介绍完成了。2.sentinel使用滑动窗口都统计啥我们来介绍下使用这个滑动窗口都来统计啥</code>public enum MetricEvent {    /</em>*     * Normal pass.     <em>/    PASS,// 通过    /</em>*     * Normal block.     <em>/    BLOCK,// 拒绝的    EXCEPTION,// 异常    SUCCESS,//成功    RT,// 耗时    /</em>*     * Passed in future quota (pre-occupied, since 1.5.0).     */    OCCUPIED_PASS } 1234567891011121314151617 `这是最基本的指标，然后通过这些指标，又可以计算出来比如说最大，最小，平均等等的一些指标。3.滑动窗口源码实现我们先来看下这个窗口里面的统计指标的实现 MetricBucket3.1 MetricBucket这个MetricBucket 是由LongAdder数组组成的，一个LongAdder就是一个MetricEvent ，也就是第二小节里面的PASS ，BLOCK等等。
我们稍微看下就可以了
<a href="https://img-blog.csdnimg.cn/202012280030215.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/202012280030215.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
可以看到它在实例化的时候创建一个LongAdder 数据，个数就是那堆event的数量。这个LongAdder 是jdk8里面的原子操作类，你可以把它简单认为AtomicLong。然后下面就是一堆get 跟add 的方法了，这里我们就不看了。
接下来再来看看那这个窗口的实现WindowWrap类3.2 WindowWrap先来看下这个成员
<a href="https://img-blog.csdnimg.cn/20201228003408745.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20201228003408745.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
窗口长度，窗口startTime ，指标统计的 都有了，下面的就没啥好看的了，我们再来看下的一个方法吧
<a href="https://img-blog.csdnimg.cn/20201228003539534.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20201228003539534.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
就是判断某个时间戳是不是在这个窗口中
时间戳要大于等于窗口开始时间 &amp;&amp; 小于这个结束时间。接下来再来看下这个管理窗口的类LeapArray3.3 LeapArray<a href="https://img-blog.csdnimg.cn/20201228003735306.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20201228003735306.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>看下它的成员， 窗口长度， 样本数sampleCount 也就是窗口个数， intervalInMs ，再就是窗口数组
看看它的构造方法
<a href="https://img-blog.csdnimg.cn/20201228003857976.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener noreferrer"><img src="https://img-blog.csdnimg.cn/20201228003857976.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3l1YW5zaGFuZ3NoZW5naHVv,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
这个构造方法其实就是计算出来这个窗口长度，创建了窗口数组。
再来看下一个很重要的方法</Object></CircuitBreaker></AuthorityRule></AuthorityRule></p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2024/01/17, 05:48:13</span></div></div> <div class="page-nav-wapper"><!----> <!----></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/e5a304/"><div>
            JVM调优
            <!----></div></a> <span class="date">12-10</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/578cf2/"><div>
            jenkins
            <!----></div></a> <span class="date">12-10</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/b6e7a0/"><div>
            Arthas
            <!----></div></a> <span class="date">12-10</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/micolor" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/micolor" title="Gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://www.niubook.xom" title="网站首页" target="_blank" class="iconfont icon-rss"></a><a href="http://wpa.qq.com/msgrd?v=3&amp;uin=349462253&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" class="iconfont icon-QQ"></a><a href="https://www.niubook.com/?contact=true" title="联系我" target="_blank" class="iconfont icon-youjian"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2024
    <span>KNOTE  | blog</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <div class="body-bg" style="background:url() center center / cover no-repeat;opacity:0.5;"></div> <!----> <!----></div><div class="global-ui"><div></div><!----><canvas id="vuepress-canvas-cursor"></canvas></div></div>
    <script src="/assets/js/app.be13efeb.js" defer></script><script src="/assets/js/2.6721fee8.js" defer></script><script src="/assets/js/518.c38887f9.js" defer></script><script src="/assets/js/4.7df05356.js" defer></script>
  </body>
</html>

---
title: 存储过程参考
date: 2020-07-16 20:36:35
categories: 
  - db
permalink: /pages/bd0ca8/
sidebar: auto
tags: 
  - null
author: 
  name: AnWen
  link: https://github.com/micolor
---

存储过程参考

<!--MORE-->

```
CREATE DEFINER=`root`@`localhost` PROCEDURE `gzProc`()
BEGIN	
DECLARE done INT DEFAULT 0;  
DECLARE i INT DEFAULT 0;  
DECLARE v_minute int;
DECLARE starttime time;
DECLARE endtime time;
DECLARE mmtime time;
DECLARE user_id VARCHAR(255);
DECLARE channel_id VARCHAR(255);
DECLARE program_name VARCHAR(255);
DECLARE date date;
DECLARE duration VARCHAR(2);
DECLARE cr CURSOR for SELECT t1.user_id,t1.channel_id,t1.program_name,t1.date,t1.starttime,t1.endtime FROM `guizhou_live_data` t1 ORDER BY user_id asc;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
OPEN cr;	
  FETCH cr INTO user_id,channel_id, program_name,date,starttime,endtime;		
	REPEAT  
-- 从游标中循环取值
  SET v_minute = floor(UNIX_TIMESTAMP(endtime) - UNIX_TIMESTAMP(starttime))/60 + 1;
	   SET i = 0;
     loop_name:LOOP -- 循环开始
				 IF i>=v_minute then 
							LEAVE loop_name;  -- 判断条件成立则结束循环 
				 END IF;
				 SET mmtime = FROM_UNIXTIME(UNIX_TIMESTAMP(starttime)+60*i,'%H:%i:00'); -- 设置开始时分
				 IF i=0 then 
							SET duration = 60 - DATE_FORMAT(starttime,'%S');
				 ELSEIF i = v_minute -1 THEN
				      SET duration = DATE_FORMAT(endtime,'%S');
				 ELSE
					    SET duration = 60;
				 END IF;
         INSERT INTO guizhou_live(mmtime,user_id,channel_id,program_name,date,duration)VALUES(mmtime,user_id,channel_id,program_name,date,duration);
				 SET i=i+1;
			end loop;  -- 循环结束 	
	FETCH NEXT FROM cr INTO user_id,channel_id, program_name,date,starttime,endtime;
  UNTIL  done = 1
  END REPEAT; 
CLOSE cr;  
END
```

